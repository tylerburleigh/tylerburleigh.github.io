name: Deploy Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: myst build --html --ci
      - name: Default light theme
        run: |
          python3 - <<'PY'
          from pathlib import Path

          root = Path("_build/html")
          marker = "/* myst-default-theme */"
          needle = 'const savedTheme = localStorage.getItem("myst:theme");'
          insert = (
              '  // myst-default-theme\\n'
              '  if (!localStorage.getItem("myst:theme")) {\\n'
              '    localStorage.setItem("myst:theme", "light");\\n'
              '  }\\n'
          )

          for path in root.rglob("*.html"):
              text = path.read_text(encoding="utf-8")
              if marker in text or needle not in text:
                  continue
              text = text.replace(needle, insert + "  " + needle, 1)
              path.write_text(text, encoding="utf-8")
          PY
      - run: |
          cp CNAME _build/html/CNAME
          if [ -f rss.xml ]; then cp rss.xml _build/html/rss.xml; fi
          if [ -f atom.xml ]; then cp atom.xml _build/html/atom.xml; fi
      - uses: actions/upload-pages-artifact@v3
        with:
          path: _build/html

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4
