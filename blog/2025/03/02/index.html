<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tyler Burleigh">
<meta name="description" content="In this post, I explore how multi-threading can improve the latency of LLM Judges. I introduce the concept of “orthogonality” as a key heuristic for determining when LLM Judge evaluation tasks can be parallelized without sacrificing quality. Then, I run a controlled experiment using MT Bench data to demonstrate the latency benefits of multi-threading, finding that the multi-threaded approach reduced latency by 38% compared to the single-threaded approach. The code used to run this experiment is also provided.">

<title>Using a multi-threaded prompt architecture to speed up LLM Judge evaluation of orthogonal quality dimensions | Tyler Burleigh – Tyler Burleigh</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../..//files/favico.png" rel="icon" type="image/png">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-dd08061cb7210c315e315379d94beb87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap-1f84303a6b4423b6cbd3f2cacdf6faa2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-PRHQZ8HPLB"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-PRHQZ8HPLB', { 'anonymize_ip': true});
</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background: #170C3A;
      }
</style>


</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Tyler Burleigh</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../cv/index.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../research/index.html"> 
<span class="menu-text">Research</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://fosstodon.org/users/tylerburleigh" rel="me"> <i class="bi bi-mastodon" role="img" aria-label="mastodon">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://bsky.app/profile/tylerburleigh.bsky.social" rel="me"> <i class="bi bi-square" role="img" aria-label="bluesky">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/tylerburleigh" rel="me"> <i class="bi bi-github" role="img" aria-label="github">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/tylerburleigh" rel="me"> <i class="bi bi-linkedin" role="img" aria-label="linkedin">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:tylerburleigh@gmail.com" rel="me"> <i class="bi bi-envelope" role="img" aria-label="email">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default blog-post page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Using a multi-threaded prompt architecture to speed up LLM Judge evaluation of orthogonal quality dimensions</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          <p>In this post, I explore how multi-threading can improve the latency of LLM Judges. I introduce the concept of “orthogonality” as a key heuristic for determining when LLM Judge evaluation tasks can be parallelized without sacrificing quality. Then, I run a controlled experiment using MT Bench data to demonstrate the latency benefits of multi-threading, finding that the multi-threaded approach reduced latency by 38% compared to the single-threaded approach. The code used to run this experiment is also provided.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">prompt-engineering</div>
                <div class="quarto-category">python</div>
                <div class="quarto-category">LLM</div>
                <div class="quarto-category">multi-threading</div>
                <div class="quarto-category">orthogonality</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.tylerburleigh.com/">Tyler Burleigh</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Sunday, March 2, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#orthogonality" id="toc-orthogonality" class="nav-link" data-scroll-target="#orthogonality">Orthogonality</a></li>
  <li><a href="#code-structure" id="toc-code-structure" class="nav-link" data-scroll-target="#code-structure">Code Structure</a>
  <ul class="collapse">
  <li><a href="#configuration" id="toc-configuration" class="nav-link" data-scroll-target="#configuration">Configuration</a></li>
  <li><a href="#the-llm-judge" id="toc-the-llm-judge" class="nav-link" data-scroll-target="#the-llm-judge">The LLM Judge</a></li>
  <li><a href="#the-experiment-runner" id="toc-the-experiment-runner" class="nav-link" data-scroll-target="#the-experiment-runner">The Experiment Runner</a></li>
  <li><a href="#other-modules" id="toc-other-modules" class="nav-link" data-scroll-target="#other-modules">Other modules</a></li>
  <li><a href="#analyzing-the-results" id="toc-analyzing-the-results" class="nav-link" data-scroll-target="#analyzing-the-results">Analyzing the Results</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Response latency is an important factor when engineering many LLM applications. There are many ways to reduce latency, such as by reducing task complexity, setting <code>max_tokens</code>, or using a smaller language model (e.g., <code>gpt-4o-mini</code> vs.&nbsp;<code>gpt-4o</code>). However, many of these approaches may sacrifice quality for speed. One approach to reducing latency that is unlikely to sacrifice quality (and in many cases may even improve it) is breaking the task down into sub-tasks that can be run in parallel.</p>
<p>In this post, I run an experiment using the MT Bench dataset to demonstrate the latency benefits of a multi-threaded LLM Judge. I engineer the same judge using two architectural approaches:</p>
<ol type="1">
<li><strong>Single-threaded (Combined) Approach</strong>: Evaluate all quality dimensions in a single LLM call</li>
<li><strong>Multi-threaded (Parallel) Approach</strong>: Evaluate each quality dimension in parallel using separate asynchronous LLM calls</li>
</ol>
<p>Using the LLM Judge, I evaluate answers to questions in the MT Bench dataset across six dimensions:</p>
<ul>
<li><strong>Helpfulness</strong>: How useful the answer is in addressing the user’s needs</li>
<li><strong>Relevance</strong>: How well the answer addresses the specific question asked</li>
<li><strong>Accuracy</strong>: Whether the information provided is factually correct</li>
<li><strong>Depth</strong>: How thoroughly the answer explores the topic</li>
<li><strong>Creativity</strong>: The originality and innovative approach in presenting the answer</li>
<li><strong>Level of Detail</strong>: The granularity and specificity of information provided</li>
</ul>
<p>Each dimension is scored on a scale of 1-10 with a rubric for what scores mean.</p>
</section>
<section id="orthogonality" class="level1">
<h1>Orthogonality</h1>
<p>When designing an LLM Judge that evaluates multiple dimensions of quality, “orthogonality” provides a useful heuristic for determining when a multi-threaded approach might be appropriate. In this context, orthogonality refers to the degree to which different evaluation dimensions can be assessed independently without requiring knowledge of the assessments made in other dimensions.</p>
<p>Theoretically, two evaluation dimensions can be considered orthogonal if:</p>
<ul>
<li>They measure conceptually distinct aspects of quality</li>
<li>Evaluating one dimension doesn’t significantly benefit from knowledge of the evaluation of other dimensions</li>
<li>The dimensions can be assessed independently without compromising the quality of the assessment</li>
</ul>
<p>The degree of orthogonality can also be quantified: If changes in the scores on one dimension have no correlation with changes in scores on the other dimension, then the dimensions are orthogonal. In practice, most evaluation dimensions in natural language tasks aren’t perfectly orthogonal, but the degree of orthogonality can help determine their suitability for parallel evaluation.</p>
<p>This statistical definition is precisely what makes orthogonality such a useful heuristic for determining parallelization potential – dimensions with low correlation coefficients can be evaluated independently without losing meaningful information that would be gained from evaluating them together.</p>
<p>The six dimensions in our experiment – Helpfulness, Relevance, Accuracy, Depth, Creativity, and Level of Detail – are largely orthogonal. For example, an answer can be highly accurate (factually correct) while lacking depth (not exploring the topic thoroughly). Similarly, an answer can be highly creative while being less helpful for the user’s specific needs. Therefore, a multi-threaded approach that evaluates each dimension in parallel does seem appropriate.</p>
</section>
<section id="code-structure" class="level1">
<h1>Code Structure</h1>
<p>The code for this experiment is organized into several Python modules:</p>
<pre><code>llm_judge/
├── config.py
├── experiment.py
├── judge.py
├── LLMClient.py
├── main.py
├── models.py
└── results.py</code></pre>
<p>Let’s consider these code modules one by one:</p>
<section id="configuration" class="level2">
<h2 class="anchored" data-anchor-id="configuration">Configuration</h2>
<p>The <code>Configuration</code> module (<code>config.py</code>) defines parameters for our experiment:</p>
<div id="baba4cc6" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the project root directory (parent of llm_judge directory)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>PROJECT_ROOT <span class="op">=</span> Path(<span class="va">__file__</span>).parent.parent.absolute()</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExperimentConfig:</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    SAMPLE_SIZE: <span class="bu">int</span> <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    RANDOM_SEED: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    MAX_TOKENS: <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    NUM_RUNS: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    RESULTS_JSONL: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.jsonl'</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    RESULTS_TXT: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.txt'</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileConfig:</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    DATASET_PATH: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'data/pairwise_evaluator_dataset.json'</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    RESULTS_JSONL: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.jsonl'</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    RESULTS_TXT: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.txt'</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-llm-judge" class="level2">
<h2 class="anchored" data-anchor-id="the-llm-judge">The LLM Judge</h2>
<p>The core module is the <code>LLMJudge</code> class (<code>judge.py</code>), which implements the single-threaded and multi-threaded approaches, and includes the prompts for the LLM.</p>
<div id="b3aa3fb1" class="cell" data-code-fold-show="false" data-execution_count="2">
<details class="code-fold">
<summary>Click to view the LLM Judge code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> (</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    QAPair, DetailedJudgmentScores, DimensionAnalysis, </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    QAPairTiming, QAPairTokens, ExperimentRun</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .LLMClient <span class="im">import</span> LLMClient</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .config <span class="im">import</span> ExperimentConfig</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .results <span class="im">import</span> ResultWriter</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LLMJudge:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> LLMClient()</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.config <span class="op">=</span> ExperimentConfig()</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.result_writer <span class="op">=</span> ResultWriter()</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _parse_scores(<span class="va">self</span>, response: <span class="bu">str</span>) <span class="op">-&gt;</span> DetailedJudgmentScores:</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Parse the LLM response into scores and thinking steps using XML format"""</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> extract_dimension_analysis(dimension: <span class="bu">str</span>) <span class="op">-&gt;</span> DimensionAnalysis:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            thinking_pattern <span class="op">=</span> <span class="ss">f"&lt;</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;.*?&lt;StepByStepThinking&gt;(.*?)&lt;/StepByStepThinking&gt;"</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            score_pattern <span class="op">=</span> <span class="ss">f"&lt;</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;.*?&lt;Score&gt;(\d+)&lt;/Score&gt;.*?&lt;/</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;"</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>            thinking_match <span class="op">=</span> re.search(thinking_pattern, response, re.DOTALL)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>            score_match <span class="op">=</span> re.search(score_pattern, response, re.DOTALL)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>            thinking <span class="op">=</span> thinking_match.group(<span class="dv">1</span>).strip() <span class="cf">if</span> thinking_match <span class="cf">else</span> <span class="st">"No analysis provided"</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> <span class="bu">int</span>(score_match.group(<span class="dv">1</span>)) <span class="cf">if</span> score_match <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> DimensionAnalysis(thinking<span class="op">=</span>thinking, score<span class="op">=</span>score)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> DetailedJudgmentScores(</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            helpfulness<span class="op">=</span>extract_dimension_analysis(<span class="st">"Helpfulness"</span>),</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>            relevance<span class="op">=</span>extract_dimension_analysis(<span class="st">"Relevance"</span>),</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>            accuracy<span class="op">=</span>extract_dimension_analysis(<span class="st">"Accuracy"</span>),</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>            depth<span class="op">=</span>extract_dimension_analysis(<span class="st">"Depth"</span>),</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            creativity<span class="op">=</span>extract_dimension_analysis(<span class="st">"Creativity"</span>),</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>            level_of_detail<span class="op">=</span>extract_dimension_analysis(<span class="st">"Level_of_Detail"</span>)</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _has_existing_result(<span class="va">self</span>, qa_pair: QAPair, judge_type: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check if this QA pair has already been evaluated by this judge type"""</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        results_file <span class="op">=</span> Path(<span class="va">self</span>.config.RESULTS_JSONL)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> results_file.exists():</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> results_file.<span class="bu">open</span>(<span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:  <span class="co"># Use Path.open() instead of open()</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> line <span class="kw">in</span> f:</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">not</span> line.strip():  <span class="co"># Skip empty lines</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                        result <span class="op">=</span> json.loads(line)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> (result[<span class="st">'judge_type'</span>] <span class="op">==</span> judge_type <span class="kw">and</span> </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>                            result[<span class="st">'question'</span>] <span class="op">==</span> qa_pair.question <span class="kw">and</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>                            result[<span class="st">'answer'</span>] <span class="op">==</span> qa_pair.answer <span class="kw">and</span> </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>                            result[<span class="st">'model'</span>] <span class="op">==</span> qa_pair.model_name):</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">print</span>(<span class="ss">f"Found existing result for </span><span class="sc">{</span>qa_pair<span class="sc">.</span>model_name<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>qa_pair<span class="sc">.</span>question[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> json.JSONDecodeError:</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span>  <span class="co"># Skip invalid JSON lines</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">FileNotFoundError</span>, <span class="pp">KeyError</span>):</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_combined(<span class="va">self</span>, qa_pairs: List[QAPair]) <span class="op">-&gt;</span> Tuple[List[DetailedJudgmentScores], <span class="bu">float</span>, List[QAPairTiming]]:</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Judge each QA pair independently with all dimensions at once"""</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.time()</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>        all_scores <span class="op">=</span> []</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>        pair_timings <span class="op">=</span> []</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define scoring guidelines</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>        scoring_guidelines <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="st">        Scoring Guidelines:</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a><span class="st">        1-2: Poor - Major issues or completely misses the mark</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="st">        3-4: Below Average - Significant room for improvement</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a><span class="st">        5-6: Average - Meets basic expectations</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="st">        7-8: Good - Strong performance with minor issues</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="st">        9-10: Excellent - Nearly perfect or perfect performance</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>        dimension_definitions <span class="op">=</span> {</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Helpfulness'</span>: <span class="st">'How useful and beneficial the answer is in addressing the user</span><span class="ch">\'</span><span class="st">s needs. A helpful answer provides practical, actionable information that serves the user</span><span class="ch">\'</span><span class="st">s purpose.'</span>,</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Relevance'</span>: <span class="st">'How well the answer addresses the specific question asked. A relevant answer stays on topic and provides information that directly answers the question.'</span>,</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Accuracy'</span>: <span class="st">'Whether the information provided is factually correct. Check for any errors, misleading statements, or questionable claims.'</span>,</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Depth'</span>: <span class="st">'How thoroughly the answer explores the topic, including underlying concepts and relationships. A deep answer goes beyond surface-level explanations.'</span>,</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Creativity'</span>: <span class="st">'The originality and innovative approach in presenting the answer. Consider unique perspectives, examples, or explanations used.'</span>,</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Level_of_Detail'</span>: <span class="st">'The granularity and specificity of information provided. A detailed answer includes specific examples, explanations, and supporting information.'</span></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, qa_pair <span class="kw">in</span> <span class="bu">enumerate</span>(qa_pairs, <span class="dv">1</span>):</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip if already evaluated</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>._has_existing_result(qa_pair, <span class="st">"combined"</span>):</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Skipping QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (combined approach) - already evaluated"</span>)</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>            pair_start_time <span class="op">=</span> time.time()</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (combined approach)"</span>)</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>qa_pair<span class="sc">.</span>question[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>            system_message <span class="op">=</span> <span class="ss">f"""You are an expert judge evaluating question-answer pairs.</span></span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a><span class="ss">            For each dimension, think step by step about your evaluation before giving a score (1-10).</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span><span class="sc">{</span>scoring_guidelines<span class="sc">}</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a><span class="ss">            Evaluation dimensions:</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Helpfulness: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Helpfulness'</span>]<span class="sc">}</span></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Relevance: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Relevance'</span>]<span class="sc">}</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Accuracy: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Accuracy'</span>]<span class="sc">}</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Depth: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Depth'</span>]<span class="sc">}</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Creativity: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Creativity'</span>]<span class="sc">}</span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Level of Detail: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Level_of_Detail'</span>]<span class="sc">}</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a><span class="ss">            Question: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>question<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a><span class="ss">            Answer: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a><span class="ss">            For each dimension, follow these steps in your evaluation:</span></span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a><span class="ss">            1. First, carefully analyze the question and answer</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a><span class="ss">            2. Consider specific strengths and weaknesses related to the dimension</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a><span class="ss">            3. Provide concrete examples from the answer to support your analysis</span></span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a><span class="ss">            4. Assign a score based on the scoring guidelines</span></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a><span class="ss">            Provide your analysis and scores in this XML format:</span></span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Helpfulness&gt;</span></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for helpfulness]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Helpfulness&gt;</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Relevance&gt;</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for relevance]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Relevance&gt;</span></span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Accuracy&gt;</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for accuracy]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Accuracy&gt;</span></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Depth&gt;</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for depth]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Depth&gt;</span></span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Creativity&gt;</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for creativity]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Creativity&gt;</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Level_of_Detail&gt;</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for level of detail]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Level_of_Detail&gt;"""</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Sending prompt to LLM for all dimensions..."</span>)</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.client.get_completion(</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>                system_message<span class="op">=</span>system_message,</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>                prompt<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>                max_tokens<span class="op">=</span><span class="va">self</span>.config.MAX_TOKENS<span class="op">*</span><span class="dv">6</span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Received response from LLM"</span>)</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="va">self</span>._parse_scores(result.content)</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>            all_scores.append(scores)</span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>            timing <span class="op">=</span> QAPairTiming(</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>                qa_index<span class="op">=</span>i,</span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span>qa_pair.question,</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>                total_time<span class="op">=</span>time.time() <span class="op">-</span> pair_start_time,</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>                tokens<span class="op">=</span>QAPairTokens(</span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>                    input_tokens<span class="op">=</span>result.input_tokens,</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>                    output_tokens<span class="op">=</span>result.output_tokens,</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>                    total_tokens<span class="op">=</span>result.input_tokens <span class="op">+</span> result.output_tokens</span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>            pair_timings.append(timing)</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write result immediately after each QA pair</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>            current_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.result_writer.write_run_results(</span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>                [qa_pair],  <span class="co"># Single QA pair</span></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>                ExperimentRun(</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>                    combined_time<span class="op">=</span>current_time,</span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>                    parallel_time<span class="op">=</span>current_time,  <span class="co"># Use same time instead of 0</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>                    combined_pair_times<span class="op">=</span>[timing],</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>                    parallel_pair_times<span class="op">=</span>[]</span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>                [scores],  <span class="co"># Single score</span></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>                []  <span class="co"># No parallel scores</span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Parsed scores for all dimensions (took </span><span class="sc">{</span>timing<span class="sc">.</span>total_time<span class="sc">:.2f}</span><span class="ss">s)"</span>)</span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Token usage: </span><span class="sc">{</span>result<span class="sc">.</span>input_tokens<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>result<span class="sc">.</span>output_tokens<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>        elapsed_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed all evaluations in </span><span class="sc">{</span>elapsed_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> all_scores, elapsed_time, pair_timings</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_dimension(<span class="va">self</span>, qa_pair: QAPair, dimension: <span class="bu">str</span>, scoring_guidelines: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>) <span class="op">-&gt;</span> Tuple[DimensionAnalysis, <span class="bu">float</span>, Tuple[<span class="bu">int</span>, <span class="bu">int</span>]]:</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>        dim_start_time <span class="op">=</span> time.time()</span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>        dimension_definitions <span class="op">=</span> {</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Helpfulness'</span>: <span class="st">'How useful and beneficial the answer is in addressing the user</span><span class="ch">\'</span><span class="st">s needs. A helpful answer provides practical, actionable information that serves the user</span><span class="ch">\'</span><span class="st">s purpose.'</span>,</span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Relevance'</span>: <span class="st">'How well the answer addresses the specific question asked. A relevant answer stays on topic and provides information that directly answers the question.'</span>,</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Accuracy'</span>: <span class="st">'Whether the information provided is factually correct. Check for any errors, misleading statements, or questionable claims.'</span>,</span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Depth'</span>: <span class="st">'How thoroughly the answer explores the topic, including underlying concepts and relationships. A deep answer goes beyond surface-level explanations.'</span>,</span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Creativity'</span>: <span class="st">'The originality and innovative approach in presenting the answer. Consider unique perspectives, examples, or explanations used.'</span>,</span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Level_of_Detail'</span>: <span class="st">'The granularity and specificity of information provided. A detailed answer includes specific examples, explanations, and supporting information.'</span></span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>        system_message <span class="op">=</span> <span class="ss">f"""You are an expert judge evaluating a specific dimension of a question-answer pair.</span></span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a><span class="ss">        Think step by step about your evaluation before giving a score (1-10).</span></span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a><span class="ss">        You are evaluating the </span><span class="sc">{</span>dimension<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss"> dimension:</span></span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span><span class="sc">{</span>dimension_definitions[dimension]<span class="sc">}</span></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span><span class="sc">{</span>scoring_guidelines<span class="sc">}</span></span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a><span class="ss">        Question: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>question<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a><span class="ss">        Answer: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a><span class="ss">        Follow these steps in your evaluation:</span></span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a><span class="ss">        1. First, carefully analyze the question and answer</span></span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a><span class="ss">        2. Consider specific strengths and weaknesses related to </span><span class="sc">{</span>dimension<span class="sc">.</span>lower()<span class="sc">}</span></span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a><span class="ss">        3. Provide concrete examples from the answer to support your analysis</span></span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a><span class="ss">        4. Assign a score based on the scoring guidelines</span></span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a><span class="ss">        Provide your analysis and score in this XML format:</span></span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;</span></span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;StepByStepThinking&gt;[your detailed analysis for </span><span class="sc">{</span>dimension<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;/</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;"""</span></span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.client.get_completion(</span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>            system_message<span class="op">=</span>system_message,</span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>            prompt<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="va">self</span>.config.MAX_TOKENS</span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>        analysis <span class="op">=</span> <span class="va">self</span>._parse_scores(result.content).<span class="fu">__getattribute__</span>(dimension.lower())</span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> analysis, time.time() <span class="op">-</span> dim_start_time, (result.input_tokens, result.output_tokens)</span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_parallel(<span class="va">self</span>, qa_pairs: List[QAPair]) <span class="op">-&gt;</span> Tuple[List[DetailedJudgmentScores], <span class="bu">float</span>, List[QAPairTiming]]:</span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Judge dimensions in parallel for each QA pair"""</span></span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.time()</span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>        all_scores <span class="op">=</span> []</span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a>        pair_timings <span class="op">=</span> []</span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add scoring guidelines</span></span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a>        scoring_guidelines <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a><span class="st">        Scoring Guidelines:</span></span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a><span class="st">        1-2: Poor - Major issues or completely misses the mark</span></span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a><span class="st">        3-4: Below Average - Significant room for improvement</span></span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a><span class="st">        5-6: Average - Meets basic expectations</span></span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a><span class="st">        7-8: Good - Strong performance with minor issues</span></span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a><span class="st">        9-10: Excellent - Nearly perfect or perfect performance</span></span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, qa_pair <span class="kw">in</span> <span class="bu">enumerate</span>(qa_pairs, <span class="dv">1</span>):</span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip if already evaluated</span></span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>._has_existing_result(qa_pair, <span class="st">"parallel"</span>):</span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Skipping QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (parallel approach) - already evaluated"</span>)</span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>            pair_start_time <span class="op">=</span> time.time()</span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (parallel approach)"</span>)</span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>qa_pair<span class="sc">.</span>question[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>            dimensions <span class="op">=</span> [<span class="st">'Helpfulness'</span>, <span class="st">'Relevance'</span>, <span class="st">'Accuracy'</span>, <span class="st">'Depth'</span>, <span class="st">'Creativity'</span>, <span class="st">'Level_of_Detail'</span>]</span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a>            tasks <span class="op">=</span> [<span class="va">self</span>.judge_dimension(qa_pair, dim, scoring_guidelines) <span class="cf">for</span> dim <span class="kw">in</span> dimensions]</span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a>            results <span class="op">=</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>tasks)</span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>            analyses, times, tokens <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>results)</span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>            dimension_times <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(dimensions, times))</span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a>            dimension_tokens <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(dimensions, tokens))</span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> DetailedJudgmentScores(</span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>                helpfulness<span class="op">=</span>analyses[<span class="dv">0</span>],</span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>                relevance<span class="op">=</span>analyses[<span class="dv">1</span>],</span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>                accuracy<span class="op">=</span>analyses[<span class="dv">2</span>],</span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>                depth<span class="op">=</span>analyses[<span class="dv">3</span>],</span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>                creativity<span class="op">=</span>analyses[<span class="dv">4</span>],</span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>                level_of_detail<span class="op">=</span>analyses[<span class="dv">5</span>]</span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>            all_scores.append(scores)</span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a>            total_time <span class="op">=</span> time.time() <span class="op">-</span> pair_start_time</span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a>            timing <span class="op">=</span> QAPairTiming(</span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a>                qa_index<span class="op">=</span>i,</span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span>qa_pair.question,</span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a>                total_time<span class="op">=</span>total_time,</span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a>                tokens<span class="op">=</span>QAPairTokens(</span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a>                    input_tokens<span class="op">=</span><span class="bu">sum</span>(t[<span class="dv">0</span>] <span class="cf">for</span> t <span class="kw">in</span> tokens),</span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a>                    output_tokens<span class="op">=</span><span class="bu">sum</span>(t[<span class="dv">1</span>] <span class="cf">for</span> t <span class="kw">in</span> tokens),</span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>                    total_tokens<span class="op">=</span><span class="bu">sum</span>(<span class="bu">sum</span>(t) <span class="cf">for</span> t <span class="kw">in</span> tokens),</span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>                    dimension_tokens<span class="op">=</span>dimension_tokens</span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>                dimension_times<span class="op">=</span>dimension_times</span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>            pair_timings.append(timing)</span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write result immediately after each QA pair</span></span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a>            current_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.result_writer.write_run_results(</span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>                [qa_pair],  <span class="co"># Single QA pair</span></span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>                ExperimentRun(</span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>                    combined_time<span class="op">=</span>current_time,  <span class="co"># Use same time instead of 0</span></span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>                    parallel_time<span class="op">=</span>current_time,</span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>                    combined_pair_times<span class="op">=</span>[],</span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a>                    parallel_pair_times<span class="op">=</span>[timing]</span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>                [],  <span class="co"># No combined scores</span></span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a>                [scores]  <span class="co"># Single parallel score</span></span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Completed parallel evaluation in </span><span class="sc">{</span>total_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> dim, t <span class="kw">in</span> dimension_times.items():</span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>                in_tokens, out_tokens <span class="op">=</span> dimension_tokens[dim]</span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>dim<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>t<span class="sc">:.2f}</span><span class="ss">s, </span><span class="sc">{</span>in_tokens<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>out_tokens<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a>        elapsed_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed all evaluations in </span><span class="sc">{</span>elapsed_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> all_scores, elapsed_time, pair_timings </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="the-experiment-runner" class="level2">
<h2 class="anchored" data-anchor-id="the-experiment-runner">The Experiment Runner</h2>
<p>The <code>Experiment Runner</code> (<code>experiment.py</code>) coordinates the evaluation process:</p>
<div id="7b8cda4f" class="cell" data-code-fold-show="false" data-execution_count="3">
<details class="code-fold">
<summary>Click to view the Experiment Runner code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional, Tuple</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statistics <span class="im">import</span> mean, stdev</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> QAPair, DetailedJudgmentScores, ExperimentRun</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .judge <span class="im">import</span> LLMJudge</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .results <span class="im">import</span> ResultWriter</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .config <span class="im">import</span> FileConfig</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExperimentRunner:</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, sample_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span>, seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sample_size <span class="op">=</span> sample_size</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        random.seed(seed)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.judge <span class="op">=</span> LLMJudge()</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.result_writer <span class="op">=</span> ResultWriter()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.config <span class="op">=</span> FileConfig()</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _load_pairwise_data(<span class="va">self</span>) <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Load QA pairs from the dataset file"""</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(<span class="va">self</span>.config.DATASET_PATH, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> json.load(f)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            qa_pairs <span class="op">=</span> []</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract both answers from each example</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> example <span class="kw">in</span> data[<span class="st">'examples'</span>]:</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                question <span class="op">=</span> example[<span class="st">'query'</span>]</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                <span class="co"># First answer</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                answer1 <span class="op">=</span> example[<span class="st">'answer'</span>]</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                model1 <span class="op">=</span> example[<span class="st">'answer_by'</span>][<span class="st">'model_name'</span>] <span class="kw">or</span> <span class="st">'unknown'</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>                qa_pairs.append(QAPair(</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                    question<span class="op">=</span>question, </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>                    answer<span class="op">=</span>answer1,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>                    model_name<span class="op">=</span>model1</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Second answer</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>                answer2 <span class="op">=</span> example[<span class="st">'second_answer'</span>]</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                model2 <span class="op">=</span> example[<span class="st">'second_answer_by'</span>][<span class="st">'model_name'</span>] <span class="kw">or</span> <span class="st">'unknown'</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>                qa_pairs.append(QAPair(</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>                    question<span class="op">=</span>question, </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>                    answer<span class="op">=</span>answer2,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>                    model_name<span class="op">=</span>model2</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> qa_pairs</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">FileNotFoundError</span>, json.JSONDecodeError) <span class="im">as</span> e:</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error loading pairwise evaluator dataset: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _sample_qa_pairs(<span class="va">self</span>, qa_pairs: List[QAPair]) <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Sample QA pairs from the dataset"""</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group QA pairs by unique question text</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        unique_questions <span class="op">=</span> {}</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> qa <span class="kw">in</span> qa_pairs:</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> qa.question <span class="kw">not</span> <span class="kw">in</span> unique_questions:</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>                unique_questions[qa.question] <span class="op">=</span> []</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            unique_questions[qa.question].append(qa)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample from unique questions</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        sampled_questions <span class="op">=</span> random.sample(<span class="bu">list</span>(unique_questions.keys()), <span class="va">self</span>.sample_size)</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each sampled question, take just the first two QA pairs</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        sampled_pairs <span class="op">=</span> []</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> question <span class="kw">in</span> sampled_questions:</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            sampled_pairs.extend(unique_questions[question][:<span class="dv">2</span>])</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sampled_pairs</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _run_single_experiment(</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, </span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        qa_pairs: List[QAPair], </span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        run_number: <span class="bu">int</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> Tuple[ExperimentRun, List[DetailedJudgmentScores], List[DetailedJudgmentScores]]:</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Run a single experiment with both combined and parallel approaches"""</span></span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        combined_scores, combined_time, combined_timings <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.judge.judge_combined(qa_pairs)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        parallel_scores, parallel_time, parallel_timings <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.judge.judge_parallel(qa_pairs)</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        run <span class="op">=</span> ExperimentRun(</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>            combined_time<span class="op">=</span>combined_time,</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>            parallel_time<span class="op">=</span>parallel_time,</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>            combined_pair_times<span class="op">=</span>combined_timings,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>            parallel_pair_times<span class="op">=</span>parallel_timings</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> run, combined_scores, parallel_scores</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _print_detailed_timing(<span class="va">self</span>, run: ExperimentRun):</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Print detailed timing information for a run"""</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Detailed Timing and Token Analysis:"</span>)</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Combined Approach QA Pair Times:"</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> timing <span class="kw">in</span> run.combined_pair_times:</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  QA Pair </span><span class="sc">{</span>timing<span class="sc">.</span>qa_index<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>timing<span class="sc">.</span>total_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    Tokens: </span><span class="sc">{</span>timing<span class="sc">.</span>tokens<span class="sc">.</span>input_tokens<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>timing<span class="sc">.</span>tokens<span class="sc">.</span>output_tokens<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Parallel Approach QA Pair Times:"</span>)</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> timing <span class="kw">in</span> run.parallel_pair_times:</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  QA Pair </span><span class="sc">{</span>timing<span class="sc">.</span>qa_index<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>timing<span class="sc">.</span>total_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> timing.dimension_times:</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> dim, time <span class="kw">in</span> timing.dimension_times.items():</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>                    tokens_in, tokens_out <span class="op">=</span> timing.tokens.dimension_tokens[dim]</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>dim<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>time<span class="sc">:.2f}</span><span class="ss">s, </span><span class="sc">{</span>tokens_in<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>tokens_out<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> load_qa_pairs(<span class="va">self</span>) <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Load and sample QA pairs from dataset"""</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>            qa_pairs <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._load_pairwise_data()</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> qa_pairs:</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>._get_fallback_pairs()</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._sample_qa_pairs(qa_pairs)</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error loading QA pairs: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._get_fallback_pairs()</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> run_experiment(<span class="va">self</span>, qa_pairs: List[QAPair], num_runs: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>) <span class="op">-&gt;</span> List[ExperimentRun]:</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Run the experiment with specified number of runs"""</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>        runs <span class="op">=</span> []</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>        combined_scores <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>        parallel_scores <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_runs):</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>            run, combined_scores, parallel_scores <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._run_single_experiment(qa_pairs, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>            runs.append(run)</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write results after each run</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.result_writer.write_run_results(</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>                qa_pairs, run, combined_scores, parallel_scores</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> runs</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_fallback_pairs() <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return fallback QA pairs if dataset loading fails"""</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>            QAPair(</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span><span class="st">"What is Python?"</span>,</span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>                answer<span class="op">=</span><span class="st">"Python is a high-level programming language known for its simplicity and readability."</span>,</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>                model_name<span class="op">=</span><span class="st">"fallback"</span></span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>            QAPair(</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span><span class="st">"How does a for loop work?"</span>,</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>                answer<span class="op">=</span><span class="st">"A for loop iterates over a sequence of elements, executing code for each element."</span>,</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>                model_name<span class="op">=</span><span class="st">"fallback"</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>        ] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And we can run the experiment with the following code in the <code>Main</code> module (<code>main.py</code>)</p>
<div id="1dd6e007" class="cell" data-code-fold-show="false" data-execution_count="4">
<details class="code-fold">
<summary>Click to view the Main module code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llm_judge.experiment <span class="im">import</span> ExperimentRunner</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llm_judge.config <span class="im">import</span> ExperimentConfig</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run():</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> ExperimentConfig()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    runner <span class="op">=</span> ExperimentRunner(</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        sample_size<span class="op">=</span>config.SAMPLE_SIZE,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        seed<span class="op">=</span>config.RANDOM_SEED</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    qa_pairs <span class="op">=</span> <span class="cf">await</span> runner.load_qa_pairs()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> runner.run_experiment(qa_pairs, config.NUM_RUNS)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Run it</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> run()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="other-modules" class="level2">
<h2 class="anchored" data-anchor-id="other-modules">Other modules</h2>
<p>The <code>Result Writer</code> module (<code>results.py</code>) is responsible for writing the results to a JSONL file.</p>
<div id="fa0b9f22" class="cell" data-code-fold-show="false" data-execution_count="5">
<details class="code-fold">
<summary>Click to view the Result Writer code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statistics <span class="im">import</span> mean, stdev</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> (</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    QAPair, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    DetailedJudgmentScores, </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    ExperimentRun,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    QAPairTiming</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .config <span class="im">import</span> FileConfig</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResultWriter:</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, config: FileConfig <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.config <span class="op">=</span> config <span class="kw">or</span> FileConfig()</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure the results directories exist</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        jsonl_path <span class="op">=</span> Path(<span class="va">self</span>.config.RESULTS_JSONL)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        txt_path <span class="op">=</span> Path(<span class="va">self</span>.config.RESULTS_TXT)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create parent directories if they don't exist</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        jsonl_path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        txt_path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create files if they don't exist (but don't clear them)</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> jsonl_path.exists():</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>            jsonl_path.touch()</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> txt_path.exists():</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            txt_path.touch()</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write_run_results(</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        qa_pairs: List[QAPair],</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        run: ExperimentRun,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        combined_scores: List[DetailedJudgmentScores],</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        parallel_scores: List[DetailedJudgmentScores]</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Write results for a single experiment run to bJSONL file"""</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._write_to_jsonl(qa_pairs, run, combined_scores, parallel_scores)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _write_to_jsonl(</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        qa_pairs: List[QAPair],</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        run: ExperimentRun,</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        combined_scores: List[DetailedJudgmentScores],</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        parallel_scores: List[DetailedJudgmentScores]</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Write results to JSONL file"""</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> format_dimension_data(dimension_name: <span class="bu">str</span>, scores: DetailedJudgmentScores, timing: QAPairTiming, is_parallel: <span class="bu">bool</span>):</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            dimension_data <span class="op">=</span> {</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">"thinking"</span>: <span class="bu">getattr</span>(scores, dimension_name.lower()).thinking,</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">"score"</span>: <span class="bu">getattr</span>(scores, dimension_name.lower()).score,</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> is_parallel <span class="kw">and</span> timing.dimension_times:</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>                dimension_data.update({</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"input_tokens"</span>: timing.tokens.dimension_tokens[dimension_name][<span class="dv">0</span>],</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"output_tokens"</span>: timing.tokens.dimension_tokens[dimension_name][<span class="dv">1</span>],</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"time_ms"</span>: <span class="bu">int</span>(timing.dimension_times[dimension_name] <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>                dimension_data.update({</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"input_tokens"</span>: <span class="va">None</span>,</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"output_tokens"</span>: <span class="va">None</span>,</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"time_ms"</span>: <span class="va">None</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> dimension_data</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> create_result_entry(qa_pair: QAPair, scores: DetailedJudgmentScores, timing: QAPairTiming, is_parallel: <span class="bu">bool</span>):</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>            dimensions <span class="op">=</span> [<span class="st">'Helpfulness'</span>, <span class="st">'Relevance'</span>, <span class="st">'Accuracy'</span>, <span class="st">'Depth'</span>, <span class="st">'Creativity'</span>, <span class="st">'Level_of_Detail'</span>]</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>            entry <span class="op">=</span> {</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>                <span class="st">"judge_type"</span>: <span class="st">"parallel"</span> <span class="cf">if</span> is_parallel <span class="cf">else</span> <span class="st">"combined"</span>,</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>                <span class="st">"question"</span>: qa_pair.question,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>                <span class="st">"answer"</span>: qa_pair.answer,</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>                <span class="st">"model"</span>: qa_pair.model_name</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> dim <span class="kw">in</span> dimensions:</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>                entry[dim.lower()] <span class="op">=</span> format_dimension_data(dim, scores, timing, is_parallel)</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>            entry.update({</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sum_input_tokens"</span>: timing.tokens.input_tokens,</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sum_output_tokens"</span>: timing.tokens.output_tokens,</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>                <span class="st">"overall_time_ms"</span>: <span class="bu">int</span>(timing.total_time <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> entry</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> Path(<span class="va">self</span>.config.RESULTS_JSONL).<span class="bu">open</span>(<span class="st">'a'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write combined approach results</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, (qa_pair, scores, timing) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(qa_pairs, combined_scores, run.combined_pair_times)):</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>                entry <span class="op">=</span> create_result_entry(qa_pair, scores, timing, is_parallel<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>                f.write(json.dumps(entry, ensure_ascii<span class="op">=</span><span class="va">False</span>) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write parallel approach results</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, (qa_pair, scores, timing) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(qa_pairs, parallel_scores, run.parallel_pair_times)):</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>                entry <span class="op">=</span> create_result_entry(qa_pair, scores, timing, is_parallel<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>                f.write(json.dumps(entry, ensure_ascii<span class="op">=</span><span class="va">False</span>) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>And the <code>Models</code> module (<code>models.py</code>) defines the data structures.</p>
<div id="cb6fea70" class="cell" data-code-fold-show="false" data-execution_count="6">
<details class="code-fold">
<summary>Click to view the Models code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple, Optional</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QAPair:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    answer: <span class="bu">str</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    model_name: <span class="bu">str</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DimensionAnalysis:</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    thinking: <span class="bu">str</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    score: <span class="bu">int</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DetailedJudgmentScores:</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    helpfulness: DimensionAnalysis</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    relevance: DimensionAnalysis</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    accuracy: DimensionAnalysis</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    depth: DimensionAnalysis</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    creativity: DimensionAnalysis</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    level_of_detail: DimensionAnalysis</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> []</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> dimension <span class="kw">in</span> [<span class="st">'helpfulness'</span>, <span class="st">'relevance'</span>, <span class="st">'accuracy'</span>, <span class="st">'depth'</span>, <span class="st">'creativity'</span>, <span class="st">'level_of_detail'</span>]:</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            analysis <span class="op">=</span> <span class="bu">getattr</span>(<span class="va">self</span>, dimension)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>            result.extend([</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>dimension<span class="sc">.</span>title()<span class="sc">}</span><span class="ss">:"</span>,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Thinking: </span><span class="sc">{</span>analysis<span class="sc">.</span>thinking<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Score: </span><span class="sc">{</span>analysis<span class="sc">.</span>score<span class="sc">}</span><span class="ss">/10"</span>,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">""</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(result)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QAPairTokens:</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    input_tokens: <span class="bu">int</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    output_tokens: <span class="bu">int</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    total_tokens: <span class="bu">int</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    dimension_tokens: Optional[Dict[<span class="bu">str</span>, Tuple[<span class="bu">int</span>, <span class="bu">int</span>]]] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QAPairTiming:</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    qa_index: <span class="bu">int</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    total_time: <span class="bu">float</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    tokens: QAPairTokens</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    dimension_times: Optional[Dict[<span class="bu">str</span>, <span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExperimentRun:</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    combined_time: <span class="bu">float</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    parallel_time: <span class="bu">float</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    combined_pair_times: List[QAPairTiming]</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>    parallel_pair_times: List[QAPairTiming]</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> time_difference(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""B - A: Positive means parallel was slower"""</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.parallel_time <span class="op">-</span> <span class="va">self</span>.combined_time</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> percent_difference(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""((B - A) / A) * 100: Positive means parallel was slower"""</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.combined_time <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">float</span>(<span class="st">'inf'</span>) <span class="cf">if</span> <span class="va">self</span>.parallel_time <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">self</span>.time_difference <span class="op">/</span> <span class="va">self</span>.combined_time) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> combined_tokens(<span class="va">self</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">int</span>, <span class="bu">int</span>, <span class="bu">int</span>]:</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Returns (input_tokens, output_tokens, total_tokens) for combined approach"""</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        input_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.input_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.combined_pair_times)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>        output_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.output_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.combined_pair_times)</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> input_tokens, output_tokens, input_tokens <span class="op">+</span> output_tokens</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> parallel_tokens(<span class="va">self</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">int</span>, <span class="bu">int</span>, <span class="bu">int</span>]:</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Returns (input_tokens, output_tokens, total_tokens) for parallel approach"""</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>        input_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.input_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.parallel_pair_times)</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>        output_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.output_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.parallel_pair_times)</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> input_tokens, output_tokens, input_tokens <span class="op">+</span> output_tokens </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="analyzing-the-results" class="level2">
<h2 class="anchored" data-anchor-id="analyzing-the-results">Analyzing the Results</h2>
<p>After running the experiment, we can analyze the latency distributions to determine if the multi-threaded approach was faster:</p>
<div id="b61bb446" class="cell" data-code-fold-show="false" data-execution_count="7">
<details class="code-fold">
<summary>Click to view the Results Analysis code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> []</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'experiment_results.jsonl'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        data.append(json.loads(line))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate data by judge type and convert to seconds</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>parallel_times <span class="op">=</span> [entry[<span class="st">'overall_time_ms'</span>]<span class="op">/</span><span class="dv">1000</span> <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'parallel'</span>]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>combined_times <span class="op">=</span> [entry[<span class="st">'overall_time_ms'</span>]<span class="op">/</span><span class="dv">1000</span> <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'combined'</span>]</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate medians</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>median_parallel <span class="op">=</span> <span class="bu">sorted</span>(parallel_times)[<span class="bu">len</span>(parallel_times)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>median_combined <span class="op">=</span> <span class="bu">sorted</span>(combined_times)[<span class="bu">len</span>(combined_times)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate pairwise percentage differences</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>pct_diffs <span class="op">=</span> []</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry_parallel <span class="kw">in</span> data:</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> entry_parallel[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'parallel'</span>:</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry_combined <span class="kw">in</span> data:</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (entry_combined[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'combined'</span> <span class="kw">and</span> </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                entry_parallel[<span class="st">'question'</span>] <span class="op">==</span> entry_combined[<span class="st">'question'</span>] <span class="kw">and</span> </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                entry_parallel.get(<span class="st">'model'</span>) <span class="op">==</span> entry_combined.get(<span class="st">'model'</span>)):</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                pct_diff <span class="op">=</span> ((entry_parallel[<span class="st">'overall_time_ms'</span>] <span class="op">-</span> entry_combined[<span class="st">'overall_time_ms'</span>]) <span class="op">/</span> </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                          entry_combined[<span class="st">'overall_time_ms'</span>] <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                pct_diffs.append(pct_diff)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>median_pct_diff <span class="op">=</span> <span class="bu">sorted</span>(pct_diffs)[<span class="bu">len</span>(pct_diffs)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create kernel density estimation</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>kernel_parallel <span class="op">=</span> stats.gaussian_kde(parallel_times)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>kernel_combined <span class="op">=</span> stats.gaussian_kde(combined_times)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create x range for smooth plotting</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>x_range <span class="op">=</span> np.linspace(<span class="bu">min</span>(<span class="bu">min</span>(parallel_times), <span class="bu">min</span>(combined_times)),</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">max</span>(<span class="bu">max</span>(parallel_times), <span class="bu">max</span>(combined_times)),</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">200</span>)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Create figure</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Add density plots</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>x_range, </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>                        y<span class="op">=</span>kernel_parallel(x_range),</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                        name<span class="op">=</span><span class="st">'Multiple Threads'</span>,</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>                        fill<span class="op">=</span><span class="st">'tozeroy'</span>,</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                        line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                        opacity<span class="op">=</span><span class="fl">0.6</span>))</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>x_range, </span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                        y<span class="op">=</span>kernel_combined(x_range),</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>                        name<span class="op">=</span><span class="st">'Single Thread'</span>,</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>                        fill<span class="op">=</span><span class="st">'tozeroy'</span>,</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>                        line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>                        opacity<span class="op">=</span><span class="fl">0.6</span>))</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Add statistics box</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>stats_text <span class="op">=</span> (</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Median response times:&lt;br&gt;"</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Multiple Threads: </span><span class="sc">{</span>median_parallel<span class="sc">:.0f}</span><span class="ss">s&lt;br&gt;"</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Single Thread: </span><span class="sc">{</span>median_combined<span class="sc">:.0f}</span><span class="ss">s&lt;br&gt;&lt;br&gt;"</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Median % difference: </span><span class="sc">{</span>median_pct_diff<span class="sc">:.0f}</span><span class="ss">%"</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>fig.add_annotation(</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="fl">0.98</span>,  <span class="co"># Changed from 0.02 to 0.98 to move to right side</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="fl">0.98</span>,</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    xref<span class="op">=</span><span class="st">"paper"</span>,</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    yref<span class="op">=</span><span class="st">"paper"</span>,</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>stats_text,</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>    showarrow<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    font<span class="op">=</span><span class="bu">dict</span>(size<span class="op">=</span><span class="dv">12</span>),</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    align<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    bgcolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    bordercolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    borderwidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    xanchor<span class="op">=</span><span class="st">"right"</span>,  <span class="co"># Changed from 'left' to 'right'</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>    yanchor<span class="op">=</span><span class="st">"top"</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Density Plot of Overall Time by Judge Type'</span>,</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Time (seconds)'</span>,</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Density'</span>,</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The density plot above shows the distribution of response times for both approaches. The multi-threaded approach was indeed faster – it reduced latency by ~38% on average (median difference) compared to the single-threaded approach.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This experiment demonstrated the significant performance benefits of a multi-threaded approach when implementing an LLM judge to evaluate text quality across multiple dimensions. By breaking down the evaluation task into six orthogonal dimensions and processing them in parallel, we achieved a ~38% reduction in latency compared to evaluating all dimensions in a single LLM call.</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tylerburleigh\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="tylerburleigh/tylerburleigh.github.io" data-repo-id="R_kgDOKMo8ww" data-category="Blog comments" data-category-id="DIC_kwDOIg6EJc4CSz92" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="dark"><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb9" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Using a multi-threaded prompt architecture to speed up LLM Judge evaluation of orthogonal quality dimensions"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-03-02</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> |</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">  In this post, I explore how multi-threading can improve the latency of LLM Judges. I introduce the concept of "orthogonality" as a key heuristic for determining when LLM Judge evaluation tasks can be parallelized without sacrificing quality. Then, I run a controlled experiment using MT Bench data to demonstrate the latency benefits of multi-threading, finding that the multi-threaded approach reduced latency by 38% compared to the single-threaded approach. The code used to run this experiment is also provided.</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">  - prompt-engineering</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">  - python</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">  - LLM</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">  - multi-threading</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">  - orthogonality</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="an">freeze:</span><span class="co"> true</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>Response latency is an important factor when engineering many LLM applications. There are many ways to reduce latency, such as by reducing task complexity, setting <span class="in">`max_tokens`</span>, or using a smaller language model (e.g., <span class="in">`gpt-4o-mini`</span> vs. <span class="in">`gpt-4o`</span>). However, many of these approaches may sacrifice quality for speed. One approach to reducing latency that is unlikely to sacrifice quality (and in many cases may even improve it) is breaking the task down into sub-tasks that can be run in parallel.</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>In this post, I run an experiment using the MT Bench dataset to demonstrate the latency benefits of a multi-threaded LLM Judge. I engineer the same judge using two architectural approaches:</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Single-threaded (Combined) Approach**: Evaluate all quality dimensions in a single LLM call</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Multi-threaded (Parallel) Approach**: Evaluate each quality dimension in parallel using separate asynchronous LLM calls</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>Using the LLM Judge, I evaluate answers to questions in the MT Bench dataset across six dimensions:</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Helpfulness**: How useful the answer is in addressing the user's needs</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Relevance**: How well the answer addresses the specific question asked</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Accuracy**: Whether the information provided is factually correct</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Depth**: How thoroughly the answer explores the topic</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Creativity**: The originality and innovative approach in presenting the answer</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Level of Detail**: The granularity and specificity of information provided</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>Each dimension is scored on a scale of 1-10 with a rubric for what scores mean.</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="fu"># Orthogonality</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>When designing an LLM Judge that evaluates multiple dimensions of quality, "orthogonality" provides a useful heuristic for determining when a multi-threaded approach might be appropriate. In this context, orthogonality refers to the degree to which different evaluation dimensions can be assessed independently without requiring knowledge of the assessments made in other dimensions.</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>Theoretically, two evaluation dimensions can be considered orthogonal if:</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>They measure conceptually distinct aspects of quality</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Evaluating one dimension doesn't significantly benefit from knowledge of the evaluation of other dimensions</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>The dimensions can be assessed independently without compromising the quality of the assessment</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>The degree of orthogonality can also be quantified: If changes in the scores on one dimension have no correlation with changes in scores on the other dimension, then the dimensions are orthogonal. In practice, most evaluation dimensions in natural language tasks aren't perfectly orthogonal, but the degree of orthogonality can help determine their suitability for parallel evaluation.</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>This statistical definition is precisely what makes orthogonality such a useful heuristic for determining parallelization potential -- dimensions with low correlation coefficients can be evaluated independently without losing meaningful information that would be gained from evaluating them together.</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>The six dimensions in our experiment -- Helpfulness, Relevance, Accuracy, Depth, Creativity, and Level of Detail -- are largely orthogonal. For example, an answer can be highly accurate (factually correct) while lacking depth (not exploring the topic thoroughly). Similarly, an answer can be highly creative while being less helpful for the user's specific needs. Therefore, a multi-threaded approach that evaluates each dimension in parallel does seem appropriate.</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="fu"># Additional benefits</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>In addition to improving the latency of LLM Judge evaluations, by breaking the task down into smaller tasks, it's also possible that the following benefits would be realized:</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Higher quality / accuracy**: By breaking the task down into smaller tasks that can be evaluated in parallel, it's possible that the quality / accuracy of the LLM Judge evaluations would be improved, due to the singular focus of each task.</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Smaller language models**: By breaking the task down into smaller tasks, it's possible that smaller language models could be used without sacrificing quality.</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="fu"># Code Structure</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>The code for this experiment is organized into several Python modules:</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a><span class="in">llm_judge/</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="in">├── config.py</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="in">├── experiment.py</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="in">├── judge.py</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="in">├── LLMClient.py</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="in">├── main.py</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a><span class="in">├── models.py</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a><span class="in">└── results.py</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>Let's consider these code modules one by one:</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="fu">## Configuration</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Configuration`</span> module (<span class="in">`config.py`</span>) defines parameters for our experiment:</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the project root directory (parent of llm_judge directory)</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>PROJECT_ROOT <span class="op">=</span> Path(<span class="va">__file__</span>).parent.parent.absolute()</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExperimentConfig:</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    SAMPLE_SIZE: <span class="bu">int</span> <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    RANDOM_SEED: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    MAX_TOKENS: <span class="bu">int</span> <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>    NUM_RUNS: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>    RESULTS_JSONL: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.jsonl'</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    RESULTS_TXT: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.txt'</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FileConfig:</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>    DATASET_PATH: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'data/pairwise_evaluator_dataset.json'</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>    RESULTS_JSONL: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.jsonl'</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>    RESULTS_TXT: Path <span class="op">=</span> PROJECT_ROOT <span class="op">/</span> <span class="st">'experiment_results.txt'</span> </span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a><span class="fu">## The LLM Judge</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>The core module is the <span class="in">`LLMJudge`</span> class (<span class="in">`judge.py`</span>), which implements the single-threaded and multi-threaded approaches, and includes the prompts for the LLM.</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold-show: false</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Click to view the LLM Judge code"</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> (</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    QAPair, DetailedJudgmentScores, DimensionAnalysis, </span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>    QAPairTiming, QAPairTokens, ExperimentRun</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .LLMClient <span class="im">import</span> LLMClient</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .config <span class="im">import</span> ExperimentConfig</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .results <span class="im">import</span> ResultWriter</span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LLMJudge:</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> LLMClient()</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.config <span class="op">=</span> ExperimentConfig()</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.result_writer <span class="op">=</span> ResultWriter()</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _parse_scores(<span class="va">self</span>, response: <span class="bu">str</span>) <span class="op">-&gt;</span> DetailedJudgmentScores:</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Parse the LLM response into scores and thinking steps using XML format"""</span></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> extract_dimension_analysis(dimension: <span class="bu">str</span>) <span class="op">-&gt;</span> DimensionAnalysis:</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>            thinking_pattern <span class="op">=</span> <span class="ss">f"&lt;</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;.*?&lt;StepByStepThinking&gt;(.*?)&lt;/StepByStepThinking&gt;"</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>            score_pattern <span class="op">=</span> <span class="ss">f"&lt;</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;.*?&lt;Score&gt;(\d+)&lt;/Score&gt;.*?&lt;/</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;"</span></span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>            thinking_match <span class="op">=</span> re.search(thinking_pattern, response, re.DOTALL)</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>            score_match <span class="op">=</span> re.search(score_pattern, response, re.DOTALL)</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>            thinking <span class="op">=</span> thinking_match.group(<span class="dv">1</span>).strip() <span class="cf">if</span> thinking_match <span class="cf">else</span> <span class="st">"No analysis provided"</span></span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> <span class="bu">int</span>(score_match.group(<span class="dv">1</span>)) <span class="cf">if</span> score_match <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> DimensionAnalysis(thinking<span class="op">=</span>thinking, score<span class="op">=</span>score)</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> DetailedJudgmentScores(</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>            helpfulness<span class="op">=</span>extract_dimension_analysis(<span class="st">"Helpfulness"</span>),</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>            relevance<span class="op">=</span>extract_dimension_analysis(<span class="st">"Relevance"</span>),</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>            accuracy<span class="op">=</span>extract_dimension_analysis(<span class="st">"Accuracy"</span>),</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>            depth<span class="op">=</span>extract_dimension_analysis(<span class="st">"Depth"</span>),</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>            creativity<span class="op">=</span>extract_dimension_analysis(<span class="st">"Creativity"</span>),</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>            level_of_detail<span class="op">=</span>extract_dimension_analysis(<span class="st">"Level_of_Detail"</span>)</span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _has_existing_result(<span class="va">self</span>, qa_pair: QAPair, judge_type: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Check if this QA pair has already been evaluated by this judge type"""</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>        results_file <span class="op">=</span> Path(<span class="va">self</span>.config.RESULTS_JSONL)</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> results_file.exists():</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> results_file.<span class="bu">open</span>(<span class="st">'r'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:  <span class="co"># Use Path.open() instead of open()</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> line <span class="kw">in</span> f:</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">not</span> line.strip():  <span class="co"># Skip empty lines</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>                        result <span class="op">=</span> json.loads(line)</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> (result[<span class="st">'judge_type'</span>] <span class="op">==</span> judge_type <span class="kw">and</span> </span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>                            result[<span class="st">'question'</span>] <span class="op">==</span> qa_pair.question <span class="kw">and</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>                            result[<span class="st">'answer'</span>] <span class="op">==</span> qa_pair.answer <span class="kw">and</span> </span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>                            result[<span class="st">'model'</span>] <span class="op">==</span> qa_pair.model_name):</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">print</span>(<span class="ss">f"Found existing result for </span><span class="sc">{</span>qa_pair<span class="sc">.</span>model_name<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>qa_pair<span class="sc">.</span>question[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> json.JSONDecodeError:</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span>  <span class="co"># Skip invalid JSON lines</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">FileNotFoundError</span>, <span class="pp">KeyError</span>):</span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_combined(<span class="va">self</span>, qa_pairs: List[QAPair]) <span class="op">-&gt;</span> Tuple[List[DetailedJudgmentScores], <span class="bu">float</span>, List[QAPairTiming]]:</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Judge each QA pair independently with all dimensions at once"""</span></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.time()</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>        all_scores <span class="op">=</span> []</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>        pair_timings <span class="op">=</span> []</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define scoring guidelines</span></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>        scoring_guidelines <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a><span class="st">        Scoring Guidelines:</span></span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a><span class="st">        1-2: Poor - Major issues or completely misses the mark</span></span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a><span class="st">        3-4: Below Average - Significant room for improvement</span></span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a><span class="st">        5-6: Average - Meets basic expectations</span></span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a><span class="st">        7-8: Good - Strong performance with minor issues</span></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a><span class="st">        9-10: Excellent - Nearly perfect or perfect performance</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>        dimension_definitions <span class="op">=</span> {</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Helpfulness'</span>: <span class="st">'How useful and beneficial the answer is in addressing the user</span><span class="ch">\'</span><span class="st">s needs. A helpful answer provides practical, actionable information that serves the user</span><span class="ch">\'</span><span class="st">s purpose.'</span>,</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Relevance'</span>: <span class="st">'How well the answer addresses the specific question asked. A relevant answer stays on topic and provides information that directly answers the question.'</span>,</span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Accuracy'</span>: <span class="st">'Whether the information provided is factually correct. Check for any errors, misleading statements, or questionable claims.'</span>,</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Depth'</span>: <span class="st">'How thoroughly the answer explores the topic, including underlying concepts and relationships. A deep answer goes beyond surface-level explanations.'</span>,</span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Creativity'</span>: <span class="st">'The originality and innovative approach in presenting the answer. Consider unique perspectives, examples, or explanations used.'</span>,</span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Level_of_Detail'</span>: <span class="st">'The granularity and specificity of information provided. A detailed answer includes specific examples, explanations, and supporting information.'</span></span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, qa_pair <span class="kw">in</span> <span class="bu">enumerate</span>(qa_pairs, <span class="dv">1</span>):</span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip if already evaluated</span></span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>._has_existing_result(qa_pair, <span class="st">"combined"</span>):</span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Skipping QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (combined approach) - already evaluated"</span>)</span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>            pair_start_time <span class="op">=</span> time.time()</span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (combined approach)"</span>)</span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>qa_pair<span class="sc">.</span>question[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>            system_message <span class="op">=</span> <span class="ss">f"""You are an expert judge evaluating question-answer pairs.</span></span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a><span class="ss">            For each dimension, think step by step about your evaluation before giving a score (1-10).</span></span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span><span class="sc">{</span>scoring_guidelines<span class="sc">}</span></span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a><span class="ss">            Evaluation dimensions:</span></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Helpfulness: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Helpfulness'</span>]<span class="sc">}</span></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Relevance: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Relevance'</span>]<span class="sc">}</span></span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Accuracy: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Accuracy'</span>]<span class="sc">}</span></span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Depth: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Depth'</span>]<span class="sc">}</span></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Creativity: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Creativity'</span>]<span class="sc">}</span></span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a><span class="ss">            - Level of Detail: </span><span class="sc">{</span>dimension_definitions[<span class="st">'Level_of_Detail'</span>]<span class="sc">}</span></span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a><span class="ss">            Question: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>question<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a><span class="ss">            Answer: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a><span class="ss">            For each dimension, follow these steps in your evaluation:</span></span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a><span class="ss">            1. First, carefully analyze the question and answer</span></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a><span class="ss">            2. Consider specific strengths and weaknesses related to the dimension</span></span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a><span class="ss">            3. Provide concrete examples from the answer to support your analysis</span></span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a><span class="ss">            4. Assign a score based on the scoring guidelines</span></span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a><span class="ss">            </span></span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a><span class="ss">            Provide your analysis and scores in this XML format:</span></span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Helpfulness&gt;</span></span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for helpfulness]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Helpfulness&gt;</span></span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Relevance&gt;</span></span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for relevance]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Relevance&gt;</span></span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Accuracy&gt;</span></span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for accuracy]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Accuracy&gt;</span></span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Depth&gt;</span></span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for depth]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Depth&gt;</span></span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Creativity&gt;</span></span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for creativity]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Creativity&gt;</span></span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Level_of_Detail&gt;</span></span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;StepByStepThinking&gt;[your detailed analysis for level of detail]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a><span class="ss">            &lt;/Level_of_Detail&gt;"""</span></span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Sending prompt to LLM for all dimensions..."</span>)</span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.client.get_completion(</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a>                system_message<span class="op">=</span>system_message,</span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>                prompt<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>                max_tokens<span class="op">=</span><span class="va">self</span>.config.MAX_TOKENS<span class="op">*</span><span class="dv">6</span></span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Received response from LLM"</span>)</span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> <span class="va">self</span>._parse_scores(result.content)</span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a>            all_scores.append(scores)</span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>            timing <span class="op">=</span> QAPairTiming(</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a>                qa_index<span class="op">=</span>i,</span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span>qa_pair.question,</span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>                total_time<span class="op">=</span>time.time() <span class="op">-</span> pair_start_time,</span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a>                tokens<span class="op">=</span>QAPairTokens(</span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>                    input_tokens<span class="op">=</span>result.input_tokens,</span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>                    output_tokens<span class="op">=</span>result.output_tokens,</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a>                    total_tokens<span class="op">=</span>result.input_tokens <span class="op">+</span> result.output_tokens</span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>            pair_timings.append(timing)</span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write result immediately after each QA pair</span></span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a>            current_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.result_writer.write_run_results(</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a>                [qa_pair],  <span class="co"># Single QA pair</span></span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>                ExperimentRun(</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a>                    combined_time<span class="op">=</span>current_time,</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>                    parallel_time<span class="op">=</span>current_time,  <span class="co"># Use same time instead of 0</span></span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>                    combined_pair_times<span class="op">=</span>[timing],</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a>                    parallel_pair_times<span class="op">=</span>[]</span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>                [scores],  <span class="co"># Single score</span></span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>                []  <span class="co"># No parallel scores</span></span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Parsed scores for all dimensions (took </span><span class="sc">{</span>timing<span class="sc">.</span>total_time<span class="sc">:.2f}</span><span class="ss">s)"</span>)</span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Token usage: </span><span class="sc">{</span>result<span class="sc">.</span>input_tokens<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>result<span class="sc">.</span>output_tokens<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a>        elapsed_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed all evaluations in </span><span class="sc">{</span>elapsed_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> all_scores, elapsed_time, pair_timings</span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_dimension(<span class="va">self</span>, qa_pair: QAPair, dimension: <span class="bu">str</span>, scoring_guidelines: <span class="bu">str</span> <span class="op">=</span> <span class="st">""</span>) <span class="op">-&gt;</span> Tuple[DimensionAnalysis, <span class="bu">float</span>, Tuple[<span class="bu">int</span>, <span class="bu">int</span>]]:</span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a>        dim_start_time <span class="op">=</span> time.time()</span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a>        dimension_definitions <span class="op">=</span> {</span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Helpfulness'</span>: <span class="st">'How useful and beneficial the answer is in addressing the user</span><span class="ch">\'</span><span class="st">s needs. A helpful answer provides practical, actionable information that serves the user</span><span class="ch">\'</span><span class="st">s purpose.'</span>,</span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Relevance'</span>: <span class="st">'How well the answer addresses the specific question asked. A relevant answer stays on topic and provides information that directly answers the question.'</span>,</span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Accuracy'</span>: <span class="st">'Whether the information provided is factually correct. Check for any errors, misleading statements, or questionable claims.'</span>,</span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Depth'</span>: <span class="st">'How thoroughly the answer explores the topic, including underlying concepts and relationships. A deep answer goes beyond surface-level explanations.'</span>,</span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Creativity'</span>: <span class="st">'The originality and innovative approach in presenting the answer. Consider unique perspectives, examples, or explanations used.'</span>,</span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Level_of_Detail'</span>: <span class="st">'The granularity and specificity of information provided. A detailed answer includes specific examples, explanations, and supporting information.'</span></span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a>        system_message <span class="op">=</span> <span class="ss">f"""You are an expert judge evaluating a specific dimension of a question-answer pair.</span></span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a><span class="ss">        Think step by step about your evaluation before giving a score (1-10).</span></span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a><span class="ss">        You are evaluating the </span><span class="sc">{</span>dimension<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss"> dimension:</span></span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span><span class="sc">{</span>dimension_definitions[dimension]<span class="sc">}</span></span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span><span class="sc">{</span>scoring_guidelines<span class="sc">}</span></span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a><span class="ss">        Question: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>question<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a><span class="ss">        Answer: ```</span><span class="sc">{</span>qa_pair<span class="sc">.</span>answer<span class="sc">}</span><span class="ss">```</span></span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a><span class="ss">        Follow these steps in your evaluation:</span></span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a><span class="ss">        1. First, carefully analyze the question and answer</span></span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a><span class="ss">        2. Consider specific strengths and weaknesses related to </span><span class="sc">{</span>dimension<span class="sc">.</span>lower()<span class="sc">}</span></span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true" tabindex="-1"></a><span class="ss">        3. Provide concrete examples from the answer to support your analysis</span></span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true" tabindex="-1"></a><span class="ss">        4. Assign a score based on the scoring guidelines</span></span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true" tabindex="-1"></a><span class="ss">        </span></span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true" tabindex="-1"></a><span class="ss">        Provide your analysis and score in this XML format:</span></span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;</span></span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;StepByStepThinking&gt;[your detailed analysis for </span><span class="sc">{</span>dimension<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss">]&lt;/StepByStepThinking&gt;</span></span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;Score&gt;[score from 1-10]&lt;/Score&gt;</span></span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true" tabindex="-1"></a><span class="ss">        &lt;/</span><span class="sc">{</span>dimension<span class="sc">}</span><span class="ss">&gt;"""</span></span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.client.get_completion(</span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true" tabindex="-1"></a>            system_message<span class="op">=</span>system_message,</span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true" tabindex="-1"></a>            prompt<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true" tabindex="-1"></a>            max_tokens<span class="op">=</span><span class="va">self</span>.config.MAX_TOKENS</span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true" tabindex="-1"></a>        analysis <span class="op">=</span> <span class="va">self</span>._parse_scores(result.content).<span class="fu">__getattribute__</span>(dimension.lower())</span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> analysis, time.time() <span class="op">-</span> dim_start_time, (result.input_tokens, result.output_tokens)</span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> judge_parallel(<span class="va">self</span>, qa_pairs: List[QAPair]) <span class="op">-&gt;</span> Tuple[List[DetailedJudgmentScores], <span class="bu">float</span>, List[QAPairTiming]]:</span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Judge dimensions in parallel for each QA pair"""</span></span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true" tabindex="-1"></a>        start_time <span class="op">=</span> time.time()</span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true" tabindex="-1"></a>        all_scores <span class="op">=</span> []</span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true" tabindex="-1"></a>        pair_timings <span class="op">=</span> []</span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add scoring guidelines</span></span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true" tabindex="-1"></a>        scoring_guidelines <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true" tabindex="-1"></a><span class="st">        Scoring Guidelines:</span></span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true" tabindex="-1"></a><span class="st">        1-2: Poor - Major issues or completely misses the mark</span></span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true" tabindex="-1"></a><span class="st">        3-4: Below Average - Significant room for improvement</span></span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true" tabindex="-1"></a><span class="st">        5-6: Average - Meets basic expectations</span></span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true" tabindex="-1"></a><span class="st">        7-8: Good - Strong performance with minor issues</span></span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true" tabindex="-1"></a><span class="st">        9-10: Excellent - Nearly perfect or perfect performance</span></span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span></span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-381"><a href="#cb9-381" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, qa_pair <span class="kw">in</span> <span class="bu">enumerate</span>(qa_pairs, <span class="dv">1</span>):</span>
<span id="cb9-382"><a href="#cb9-382" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Skip if already evaluated</span></span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>._has_existing_result(qa_pair, <span class="st">"parallel"</span>):</span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Skipping QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (parallel approach) - already evaluated"</span>)</span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true" tabindex="-1"></a>            pair_start_time <span class="op">=</span> time.time()</span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Processing QA pair </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(qa_pairs)<span class="sc">}</span><span class="ss"> (parallel approach)"</span>)</span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>qa_pair<span class="sc">.</span>question[:<span class="dv">50</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb9-390"><a href="#cb9-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-391"><a href="#cb9-391" aria-hidden="true" tabindex="-1"></a>            dimensions <span class="op">=</span> [<span class="st">'Helpfulness'</span>, <span class="st">'Relevance'</span>, <span class="st">'Accuracy'</span>, <span class="st">'Depth'</span>, <span class="st">'Creativity'</span>, <span class="st">'Level_of_Detail'</span>]</span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true" tabindex="-1"></a>            tasks <span class="op">=</span> [<span class="va">self</span>.judge_dimension(qa_pair, dim, scoring_guidelines) <span class="cf">for</span> dim <span class="kw">in</span> dimensions]</span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true" tabindex="-1"></a>            results <span class="op">=</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>tasks)</span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true" tabindex="-1"></a>            analyses, times, tokens <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>results)</span>
<span id="cb9-396"><a href="#cb9-396" aria-hidden="true" tabindex="-1"></a>            dimension_times <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(dimensions, times))</span>
<span id="cb9-397"><a href="#cb9-397" aria-hidden="true" tabindex="-1"></a>            dimension_tokens <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(dimensions, tokens))</span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> DetailedJudgmentScores(</span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true" tabindex="-1"></a>                helpfulness<span class="op">=</span>analyses[<span class="dv">0</span>],</span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true" tabindex="-1"></a>                relevance<span class="op">=</span>analyses[<span class="dv">1</span>],</span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true" tabindex="-1"></a>                accuracy<span class="op">=</span>analyses[<span class="dv">2</span>],</span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true" tabindex="-1"></a>                depth<span class="op">=</span>analyses[<span class="dv">3</span>],</span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true" tabindex="-1"></a>                creativity<span class="op">=</span>analyses[<span class="dv">4</span>],</span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true" tabindex="-1"></a>                level_of_detail<span class="op">=</span>analyses[<span class="dv">5</span>]</span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true" tabindex="-1"></a>            all_scores.append(scores)</span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true" tabindex="-1"></a>            total_time <span class="op">=</span> time.time() <span class="op">-</span> pair_start_time</span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true" tabindex="-1"></a>            timing <span class="op">=</span> QAPairTiming(</span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true" tabindex="-1"></a>                qa_index<span class="op">=</span>i,</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span>qa_pair.question,</span>
<span id="cb9-413"><a href="#cb9-413" aria-hidden="true" tabindex="-1"></a>                total_time<span class="op">=</span>total_time,</span>
<span id="cb9-414"><a href="#cb9-414" aria-hidden="true" tabindex="-1"></a>                tokens<span class="op">=</span>QAPairTokens(</span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true" tabindex="-1"></a>                    input_tokens<span class="op">=</span><span class="bu">sum</span>(t[<span class="dv">0</span>] <span class="cf">for</span> t <span class="kw">in</span> tokens),</span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true" tabindex="-1"></a>                    output_tokens<span class="op">=</span><span class="bu">sum</span>(t[<span class="dv">1</span>] <span class="cf">for</span> t <span class="kw">in</span> tokens),</span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true" tabindex="-1"></a>                    total_tokens<span class="op">=</span><span class="bu">sum</span>(<span class="bu">sum</span>(t) <span class="cf">for</span> t <span class="kw">in</span> tokens),</span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true" tabindex="-1"></a>                    dimension_tokens<span class="op">=</span>dimension_tokens</span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true" tabindex="-1"></a>                dimension_times<span class="op">=</span>dimension_times</span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true" tabindex="-1"></a>            pair_timings.append(timing)</span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write result immediately after each QA pair</span></span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true" tabindex="-1"></a>            current_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.result_writer.write_run_results(</span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true" tabindex="-1"></a>                [qa_pair],  <span class="co"># Single QA pair</span></span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true" tabindex="-1"></a>                ExperimentRun(</span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true" tabindex="-1"></a>                    combined_time<span class="op">=</span>current_time,  <span class="co"># Use same time instead of 0</span></span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true" tabindex="-1"></a>                    parallel_time<span class="op">=</span>current_time,</span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true" tabindex="-1"></a>                    combined_pair_times<span class="op">=</span>[],</span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true" tabindex="-1"></a>                    parallel_pair_times<span class="op">=</span>[timing]</span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true" tabindex="-1"></a>                [],  <span class="co"># No combined scores</span></span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true" tabindex="-1"></a>                [scores]  <span class="co"># Single parallel score</span></span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Completed parallel evaluation in </span><span class="sc">{</span>total_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> dim, t <span class="kw">in</span> dimension_times.items():</span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true" tabindex="-1"></a>                in_tokens, out_tokens <span class="op">=</span> dimension_tokens[dim]</span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>dim<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>t<span class="sc">:.2f}</span><span class="ss">s, </span><span class="sc">{</span>in_tokens<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>out_tokens<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true" tabindex="-1"></a>        elapsed_time <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed all evaluations in </span><span class="sc">{</span>elapsed_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> all_scores, elapsed_time, pair_timings </span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Experiment Runner</span></span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Experiment Runner`</span> (<span class="in">`experiment.py`</span>) coordinates the evaluation process:</span>
<span id="cb9-451"><a href="#cb9-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold-show: false</span></span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Click to view the Experiment Runner code"</span></span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Optional, Tuple</span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statistics <span class="im">import</span> mean, stdev</span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> QAPair, DetailedJudgmentScores, ExperimentRun</span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .judge <span class="im">import</span> LLMJudge</span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .results <span class="im">import</span> ResultWriter</span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .config <span class="im">import</span> FileConfig</span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExperimentRunner:</span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, sample_size: <span class="bu">int</span> <span class="op">=</span> <span class="dv">16</span>, seed: <span class="bu">int</span> <span class="op">=</span> <span class="dv">42</span>):</span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sample_size <span class="op">=</span> sample_size</span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true" tabindex="-1"></a>        random.seed(seed)</span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.judge <span class="op">=</span> LLMJudge()</span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.result_writer <span class="op">=</span> ResultWriter()</span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.config <span class="op">=</span> FileConfig()</span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _load_pairwise_data(<span class="va">self</span>) <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Load QA pairs from the dataset file"""</span></span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true" tabindex="-1"></a>        <span class="im">import</span> json</span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> <span class="bu">open</span>(<span class="va">self</span>.config.DATASET_PATH, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb9-483"><a href="#cb9-483" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> json.load(f)</span>
<span id="cb9-484"><a href="#cb9-484" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-485"><a href="#cb9-485" aria-hidden="true" tabindex="-1"></a>            qa_pairs <span class="op">=</span> []</span>
<span id="cb9-486"><a href="#cb9-486" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-487"><a href="#cb9-487" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract both answers from each example</span></span>
<span id="cb9-488"><a href="#cb9-488" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> example <span class="kw">in</span> data[<span class="st">'examples'</span>]:</span>
<span id="cb9-489"><a href="#cb9-489" aria-hidden="true" tabindex="-1"></a>                question <span class="op">=</span> example[<span class="st">'query'</span>]</span>
<span id="cb9-490"><a href="#cb9-490" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-491"><a href="#cb9-491" aria-hidden="true" tabindex="-1"></a>                <span class="co"># First answer</span></span>
<span id="cb9-492"><a href="#cb9-492" aria-hidden="true" tabindex="-1"></a>                answer1 <span class="op">=</span> example[<span class="st">'answer'</span>]</span>
<span id="cb9-493"><a href="#cb9-493" aria-hidden="true" tabindex="-1"></a>                model1 <span class="op">=</span> example[<span class="st">'answer_by'</span>][<span class="st">'model_name'</span>] <span class="kw">or</span> <span class="st">'unknown'</span></span>
<span id="cb9-494"><a href="#cb9-494" aria-hidden="true" tabindex="-1"></a>                qa_pairs.append(QAPair(</span>
<span id="cb9-495"><a href="#cb9-495" aria-hidden="true" tabindex="-1"></a>                    question<span class="op">=</span>question, </span>
<span id="cb9-496"><a href="#cb9-496" aria-hidden="true" tabindex="-1"></a>                    answer<span class="op">=</span>answer1,</span>
<span id="cb9-497"><a href="#cb9-497" aria-hidden="true" tabindex="-1"></a>                    model_name<span class="op">=</span>model1</span>
<span id="cb9-498"><a href="#cb9-498" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb9-499"><a href="#cb9-499" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-500"><a href="#cb9-500" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Second answer</span></span>
<span id="cb9-501"><a href="#cb9-501" aria-hidden="true" tabindex="-1"></a>                answer2 <span class="op">=</span> example[<span class="st">'second_answer'</span>]</span>
<span id="cb9-502"><a href="#cb9-502" aria-hidden="true" tabindex="-1"></a>                model2 <span class="op">=</span> example[<span class="st">'second_answer_by'</span>][<span class="st">'model_name'</span>] <span class="kw">or</span> <span class="st">'unknown'</span></span>
<span id="cb9-503"><a href="#cb9-503" aria-hidden="true" tabindex="-1"></a>                qa_pairs.append(QAPair(</span>
<span id="cb9-504"><a href="#cb9-504" aria-hidden="true" tabindex="-1"></a>                    question<span class="op">=</span>question, </span>
<span id="cb9-505"><a href="#cb9-505" aria-hidden="true" tabindex="-1"></a>                    answer<span class="op">=</span>answer2,</span>
<span id="cb9-506"><a href="#cb9-506" aria-hidden="true" tabindex="-1"></a>                    model_name<span class="op">=</span>model2</span>
<span id="cb9-507"><a href="#cb9-507" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb9-508"><a href="#cb9-508" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-509"><a href="#cb9-509" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> qa_pairs</span>
<span id="cb9-510"><a href="#cb9-510" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-511"><a href="#cb9-511" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">FileNotFoundError</span>, json.JSONDecodeError) <span class="im">as</span> e:</span>
<span id="cb9-512"><a href="#cb9-512" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error loading pairwise evaluator dataset: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-513"><a href="#cb9-513" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb9-514"><a href="#cb9-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-515"><a href="#cb9-515" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _sample_qa_pairs(<span class="va">self</span>, qa_pairs: List[QAPair]) <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb9-516"><a href="#cb9-516" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Sample QA pairs from the dataset"""</span></span>
<span id="cb9-517"><a href="#cb9-517" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group QA pairs by unique question text</span></span>
<span id="cb9-518"><a href="#cb9-518" aria-hidden="true" tabindex="-1"></a>        unique_questions <span class="op">=</span> {}</span>
<span id="cb9-519"><a href="#cb9-519" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> qa <span class="kw">in</span> qa_pairs:</span>
<span id="cb9-520"><a href="#cb9-520" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> qa.question <span class="kw">not</span> <span class="kw">in</span> unique_questions:</span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true" tabindex="-1"></a>                unique_questions[qa.question] <span class="op">=</span> []</span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true" tabindex="-1"></a>            unique_questions[qa.question].append(qa)</span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample from unique questions</span></span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true" tabindex="-1"></a>        sampled_questions <span class="op">=</span> random.sample(<span class="bu">list</span>(unique_questions.keys()), <span class="va">self</span>.sample_size)</span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each sampled question, take just the first two QA pairs</span></span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true" tabindex="-1"></a>        sampled_pairs <span class="op">=</span> []</span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> question <span class="kw">in</span> sampled_questions:</span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true" tabindex="-1"></a>            sampled_pairs.extend(unique_questions[question][:<span class="dv">2</span>])</span>
<span id="cb9-531"><a href="#cb9-531" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-532"><a href="#cb9-532" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sampled_pairs</span>
<span id="cb9-533"><a href="#cb9-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-534"><a href="#cb9-534" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> _run_single_experiment(</span>
<span id="cb9-535"><a href="#cb9-535" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, </span>
<span id="cb9-536"><a href="#cb9-536" aria-hidden="true" tabindex="-1"></a>        qa_pairs: List[QAPair], </span>
<span id="cb9-537"><a href="#cb9-537" aria-hidden="true" tabindex="-1"></a>        run_number: <span class="bu">int</span></span>
<span id="cb9-538"><a href="#cb9-538" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> Tuple[ExperimentRun, List[DetailedJudgmentScores], List[DetailedJudgmentScores]]:</span>
<span id="cb9-539"><a href="#cb9-539" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Run a single experiment with both combined and parallel approaches"""</span></span>
<span id="cb9-540"><a href="#cb9-540" aria-hidden="true" tabindex="-1"></a>        combined_scores, combined_time, combined_timings <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.judge.judge_combined(qa_pairs)</span>
<span id="cb9-541"><a href="#cb9-541" aria-hidden="true" tabindex="-1"></a>        parallel_scores, parallel_time, parallel_timings <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>.judge.judge_parallel(qa_pairs)</span>
<span id="cb9-542"><a href="#cb9-542" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-543"><a href="#cb9-543" aria-hidden="true" tabindex="-1"></a>        run <span class="op">=</span> ExperimentRun(</span>
<span id="cb9-544"><a href="#cb9-544" aria-hidden="true" tabindex="-1"></a>            combined_time<span class="op">=</span>combined_time,</span>
<span id="cb9-545"><a href="#cb9-545" aria-hidden="true" tabindex="-1"></a>            parallel_time<span class="op">=</span>parallel_time,</span>
<span id="cb9-546"><a href="#cb9-546" aria-hidden="true" tabindex="-1"></a>            combined_pair_times<span class="op">=</span>combined_timings,</span>
<span id="cb9-547"><a href="#cb9-547" aria-hidden="true" tabindex="-1"></a>            parallel_pair_times<span class="op">=</span>parallel_timings</span>
<span id="cb9-548"><a href="#cb9-548" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-549"><a href="#cb9-549" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-550"><a href="#cb9-550" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> run, combined_scores, parallel_scores</span>
<span id="cb9-551"><a href="#cb9-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-552"><a href="#cb9-552" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _print_detailed_timing(<span class="va">self</span>, run: ExperimentRun):</span>
<span id="cb9-553"><a href="#cb9-553" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Print detailed timing information for a run"""</span></span>
<span id="cb9-554"><a href="#cb9-554" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Detailed Timing and Token Analysis:"</span>)</span>
<span id="cb9-555"><a href="#cb9-555" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-556"><a href="#cb9-556" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Combined Approach QA Pair Times:"</span>)</span>
<span id="cb9-557"><a href="#cb9-557" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> timing <span class="kw">in</span> run.combined_pair_times:</span>
<span id="cb9-558"><a href="#cb9-558" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  QA Pair </span><span class="sc">{</span>timing<span class="sc">.</span>qa_index<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>timing<span class="sc">.</span>total_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb9-559"><a href="#cb9-559" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    Tokens: </span><span class="sc">{</span>timing<span class="sc">.</span>tokens<span class="sc">.</span>input_tokens<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>timing<span class="sc">.</span>tokens<span class="sc">.</span>output_tokens<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb9-560"><a href="#cb9-560" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-561"><a href="#cb9-561" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Parallel Approach QA Pair Times:"</span>)</span>
<span id="cb9-562"><a href="#cb9-562" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> timing <span class="kw">in</span> run.parallel_pair_times:</span>
<span id="cb9-563"><a href="#cb9-563" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  QA Pair </span><span class="sc">{</span>timing<span class="sc">.</span>qa_index<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>timing<span class="sc">.</span>total_time<span class="sc">:.2f}</span><span class="ss">s"</span>)</span>
<span id="cb9-564"><a href="#cb9-564" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> timing.dimension_times:</span>
<span id="cb9-565"><a href="#cb9-565" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> dim, time <span class="kw">in</span> timing.dimension_times.items():</span>
<span id="cb9-566"><a href="#cb9-566" aria-hidden="true" tabindex="-1"></a>                    tokens_in, tokens_out <span class="op">=</span> timing.tokens.dimension_tokens[dim]</span>
<span id="cb9-567"><a href="#cb9-567" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>dim<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>time<span class="sc">:.2f}</span><span class="ss">s, </span><span class="sc">{</span>tokens_in<span class="sc">}</span><span class="ss"> in, </span><span class="sc">{</span>tokens_out<span class="sc">}</span><span class="ss"> out"</span>)</span>
<span id="cb9-568"><a href="#cb9-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-569"><a href="#cb9-569" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> load_qa_pairs(<span class="va">self</span>) <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb9-570"><a href="#cb9-570" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Load and sample QA pairs from dataset"""</span></span>
<span id="cb9-571"><a href="#cb9-571" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-572"><a href="#cb9-572" aria-hidden="true" tabindex="-1"></a>            qa_pairs <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._load_pairwise_data()</span>
<span id="cb9-573"><a href="#cb9-573" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> qa_pairs:</span>
<span id="cb9-574"><a href="#cb9-574" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>._get_fallback_pairs()</span>
<span id="cb9-575"><a href="#cb9-575" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-576"><a href="#cb9-576" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._sample_qa_pairs(qa_pairs)</span>
<span id="cb9-577"><a href="#cb9-577" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-578"><a href="#cb9-578" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Error loading QA pairs: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-579"><a href="#cb9-579" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._get_fallback_pairs()</span>
<span id="cb9-580"><a href="#cb9-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-581"><a href="#cb9-581" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="kw">def</span> run_experiment(<span class="va">self</span>, qa_pairs: List[QAPair], num_runs: <span class="bu">int</span> <span class="op">=</span> <span class="dv">1</span>) <span class="op">-&gt;</span> List[ExperimentRun]:</span>
<span id="cb9-582"><a href="#cb9-582" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Run the experiment with specified number of runs"""</span></span>
<span id="cb9-583"><a href="#cb9-583" aria-hidden="true" tabindex="-1"></a>        runs <span class="op">=</span> []</span>
<span id="cb9-584"><a href="#cb9-584" aria-hidden="true" tabindex="-1"></a>        combined_scores <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-585"><a href="#cb9-585" aria-hidden="true" tabindex="-1"></a>        parallel_scores <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-586"><a href="#cb9-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-587"><a href="#cb9-587" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_runs):</span>
<span id="cb9-588"><a href="#cb9-588" aria-hidden="true" tabindex="-1"></a>            run, combined_scores, parallel_scores <span class="op">=</span> <span class="cf">await</span> <span class="va">self</span>._run_single_experiment(qa_pairs, i <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb9-589"><a href="#cb9-589" aria-hidden="true" tabindex="-1"></a>            runs.append(run)</span>
<span id="cb9-590"><a href="#cb9-590" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-591"><a href="#cb9-591" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write results after each run</span></span>
<span id="cb9-592"><a href="#cb9-592" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.result_writer.write_run_results(</span>
<span id="cb9-593"><a href="#cb9-593" aria-hidden="true" tabindex="-1"></a>                qa_pairs, run, combined_scores, parallel_scores</span>
<span id="cb9-594"><a href="#cb9-594" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-595"><a href="#cb9-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-596"><a href="#cb9-596" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> runs</span>
<span id="cb9-597"><a href="#cb9-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-598"><a href="#cb9-598" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb9-599"><a href="#cb9-599" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _get_fallback_pairs() <span class="op">-&gt;</span> List[QAPair]:</span>
<span id="cb9-600"><a href="#cb9-600" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Return fallback QA pairs if dataset loading fails"""</span></span>
<span id="cb9-601"><a href="#cb9-601" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [</span>
<span id="cb9-602"><a href="#cb9-602" aria-hidden="true" tabindex="-1"></a>            QAPair(</span>
<span id="cb9-603"><a href="#cb9-603" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span><span class="st">"What is Python?"</span>,</span>
<span id="cb9-604"><a href="#cb9-604" aria-hidden="true" tabindex="-1"></a>                answer<span class="op">=</span><span class="st">"Python is a high-level programming language known for its simplicity and readability."</span>,</span>
<span id="cb9-605"><a href="#cb9-605" aria-hidden="true" tabindex="-1"></a>                model_name<span class="op">=</span><span class="st">"fallback"</span></span>
<span id="cb9-606"><a href="#cb9-606" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb9-607"><a href="#cb9-607" aria-hidden="true" tabindex="-1"></a>            QAPair(</span>
<span id="cb9-608"><a href="#cb9-608" aria-hidden="true" tabindex="-1"></a>                question<span class="op">=</span><span class="st">"How does a for loop work?"</span>,</span>
<span id="cb9-609"><a href="#cb9-609" aria-hidden="true" tabindex="-1"></a>                answer<span class="op">=</span><span class="st">"A for loop iterates over a sequence of elements, executing code for each element."</span>,</span>
<span id="cb9-610"><a href="#cb9-610" aria-hidden="true" tabindex="-1"></a>                model_name<span class="op">=</span><span class="st">"fallback"</span></span>
<span id="cb9-611"><a href="#cb9-611" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb9-612"><a href="#cb9-612" aria-hidden="true" tabindex="-1"></a>        ] </span>
<span id="cb9-613"><a href="#cb9-613" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-614"><a href="#cb9-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-615"><a href="#cb9-615" aria-hidden="true" tabindex="-1"></a>And we can run the experiment with the following code in the <span class="in">`Main`</span> module (<span class="in">`main.py`</span>)</span>
<span id="cb9-616"><a href="#cb9-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-619"><a href="#cb9-619" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-620"><a href="#cb9-620" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-621"><a href="#cb9-621" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-622"><a href="#cb9-622" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold-show: false</span></span>
<span id="cb9-623"><a href="#cb9-623" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Click to view the Main module code"</span></span>
<span id="cb9-624"><a href="#cb9-624" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llm_judge.experiment <span class="im">import</span> ExperimentRunner</span>
<span id="cb9-625"><a href="#cb9-625" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> llm_judge.config <span class="im">import</span> ExperimentConfig</span>
<span id="cb9-626"><a href="#cb9-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-627"><a href="#cb9-627" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> run():</span>
<span id="cb9-628"><a href="#cb9-628" aria-hidden="true" tabindex="-1"></a>    config <span class="op">=</span> ExperimentConfig()</span>
<span id="cb9-629"><a href="#cb9-629" aria-hidden="true" tabindex="-1"></a>    runner <span class="op">=</span> ExperimentRunner(</span>
<span id="cb9-630"><a href="#cb9-630" aria-hidden="true" tabindex="-1"></a>        sample_size<span class="op">=</span>config.SAMPLE_SIZE,</span>
<span id="cb9-631"><a href="#cb9-631" aria-hidden="true" tabindex="-1"></a>        seed<span class="op">=</span>config.RANDOM_SEED</span>
<span id="cb9-632"><a href="#cb9-632" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-633"><a href="#cb9-633" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-634"><a href="#cb9-634" aria-hidden="true" tabindex="-1"></a>    qa_pairs <span class="op">=</span> <span class="cf">await</span> runner.load_qa_pairs()</span>
<span id="cb9-635"><a href="#cb9-635" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> runner.run_experiment(qa_pairs, config.NUM_RUNS)</span>
<span id="cb9-636"><a href="#cb9-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-637"><a href="#cb9-637" aria-hidden="true" tabindex="-1"></a><span class="co"># Run it</span></span>
<span id="cb9-638"><a href="#cb9-638" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> run()</span>
<span id="cb9-639"><a href="#cb9-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-640"><a href="#cb9-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-641"><a href="#cb9-641" aria-hidden="true" tabindex="-1"></a><span class="fu">## Other modules</span></span>
<span id="cb9-642"><a href="#cb9-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-643"><a href="#cb9-643" aria-hidden="true" tabindex="-1"></a>The <span class="in">`Result Writer`</span> module (<span class="in">`results.py`</span>) is responsible for writing the results to a JSONL file.</span>
<span id="cb9-644"><a href="#cb9-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-647"><a href="#cb9-647" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-648"><a href="#cb9-648" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-649"><a href="#cb9-649" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-650"><a href="#cb9-650" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold-show: false</span></span>
<span id="cb9-651"><a href="#cb9-651" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Click to view the Result Writer code"</span></span>
<span id="cb9-652"><a href="#cb9-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-653"><a href="#cb9-653" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb9-654"><a href="#cb9-654" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb9-655"><a href="#cb9-655" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statistics <span class="im">import</span> mean, stdev</span>
<span id="cb9-656"><a href="#cb9-656" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb9-657"><a href="#cb9-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-658"><a href="#cb9-658" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .models <span class="im">import</span> (</span>
<span id="cb9-659"><a href="#cb9-659" aria-hidden="true" tabindex="-1"></a>    QAPair, </span>
<span id="cb9-660"><a href="#cb9-660" aria-hidden="true" tabindex="-1"></a>    DetailedJudgmentScores, </span>
<span id="cb9-661"><a href="#cb9-661" aria-hidden="true" tabindex="-1"></a>    ExperimentRun,</span>
<span id="cb9-662"><a href="#cb9-662" aria-hidden="true" tabindex="-1"></a>    QAPairTiming</span>
<span id="cb9-663"><a href="#cb9-663" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-664"><a href="#cb9-664" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .config <span class="im">import</span> FileConfig</span>
<span id="cb9-665"><a href="#cb9-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-666"><a href="#cb9-666" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ResultWriter:</span>
<span id="cb9-667"><a href="#cb9-667" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, config: FileConfig <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb9-668"><a href="#cb9-668" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.config <span class="op">=</span> config <span class="kw">or</span> FileConfig()</span>
<span id="cb9-669"><a href="#cb9-669" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-670"><a href="#cb9-670" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure the results directories exist</span></span>
<span id="cb9-671"><a href="#cb9-671" aria-hidden="true" tabindex="-1"></a>        jsonl_path <span class="op">=</span> Path(<span class="va">self</span>.config.RESULTS_JSONL)</span>
<span id="cb9-672"><a href="#cb9-672" aria-hidden="true" tabindex="-1"></a>        txt_path <span class="op">=</span> Path(<span class="va">self</span>.config.RESULTS_TXT)</span>
<span id="cb9-673"><a href="#cb9-673" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-674"><a href="#cb9-674" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create parent directories if they don't exist</span></span>
<span id="cb9-675"><a href="#cb9-675" aria-hidden="true" tabindex="-1"></a>        jsonl_path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-676"><a href="#cb9-676" aria-hidden="true" tabindex="-1"></a>        txt_path.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-677"><a href="#cb9-677" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-678"><a href="#cb9-678" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create files if they don't exist (but don't clear them)</span></span>
<span id="cb9-679"><a href="#cb9-679" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> jsonl_path.exists():</span>
<span id="cb9-680"><a href="#cb9-680" aria-hidden="true" tabindex="-1"></a>            jsonl_path.touch()</span>
<span id="cb9-681"><a href="#cb9-681" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> txt_path.exists():</span>
<span id="cb9-682"><a href="#cb9-682" aria-hidden="true" tabindex="-1"></a>            txt_path.touch()</span>
<span id="cb9-683"><a href="#cb9-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-684"><a href="#cb9-684" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write_run_results(</span>
<span id="cb9-685"><a href="#cb9-685" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb9-686"><a href="#cb9-686" aria-hidden="true" tabindex="-1"></a>        qa_pairs: List[QAPair],</span>
<span id="cb9-687"><a href="#cb9-687" aria-hidden="true" tabindex="-1"></a>        run: ExperimentRun,</span>
<span id="cb9-688"><a href="#cb9-688" aria-hidden="true" tabindex="-1"></a>        combined_scores: List[DetailedJudgmentScores],</span>
<span id="cb9-689"><a href="#cb9-689" aria-hidden="true" tabindex="-1"></a>        parallel_scores: List[DetailedJudgmentScores]</span>
<span id="cb9-690"><a href="#cb9-690" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-691"><a href="#cb9-691" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Write results for a single experiment run to bJSONL file"""</span></span>
<span id="cb9-692"><a href="#cb9-692" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._write_to_jsonl(qa_pairs, run, combined_scores, parallel_scores)</span>
<span id="cb9-693"><a href="#cb9-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-694"><a href="#cb9-694" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _write_to_jsonl(</span>
<span id="cb9-695"><a href="#cb9-695" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb9-696"><a href="#cb9-696" aria-hidden="true" tabindex="-1"></a>        qa_pairs: List[QAPair],</span>
<span id="cb9-697"><a href="#cb9-697" aria-hidden="true" tabindex="-1"></a>        run: ExperimentRun,</span>
<span id="cb9-698"><a href="#cb9-698" aria-hidden="true" tabindex="-1"></a>        combined_scores: List[DetailedJudgmentScores],</span>
<span id="cb9-699"><a href="#cb9-699" aria-hidden="true" tabindex="-1"></a>        parallel_scores: List[DetailedJudgmentScores]</span>
<span id="cb9-700"><a href="#cb9-700" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb9-701"><a href="#cb9-701" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Write results to JSONL file"""</span></span>
<span id="cb9-702"><a href="#cb9-702" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> format_dimension_data(dimension_name: <span class="bu">str</span>, scores: DetailedJudgmentScores, timing: QAPairTiming, is_parallel: <span class="bu">bool</span>):</span>
<span id="cb9-703"><a href="#cb9-703" aria-hidden="true" tabindex="-1"></a>            dimension_data <span class="op">=</span> {</span>
<span id="cb9-704"><a href="#cb9-704" aria-hidden="true" tabindex="-1"></a>                <span class="st">"thinking"</span>: <span class="bu">getattr</span>(scores, dimension_name.lower()).thinking,</span>
<span id="cb9-705"><a href="#cb9-705" aria-hidden="true" tabindex="-1"></a>                <span class="st">"score"</span>: <span class="bu">getattr</span>(scores, dimension_name.lower()).score,</span>
<span id="cb9-706"><a href="#cb9-706" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb9-707"><a href="#cb9-707" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-708"><a href="#cb9-708" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> is_parallel <span class="kw">and</span> timing.dimension_times:</span>
<span id="cb9-709"><a href="#cb9-709" aria-hidden="true" tabindex="-1"></a>                dimension_data.update({</span>
<span id="cb9-710"><a href="#cb9-710" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"input_tokens"</span>: timing.tokens.dimension_tokens[dimension_name][<span class="dv">0</span>],</span>
<span id="cb9-711"><a href="#cb9-711" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"output_tokens"</span>: timing.tokens.dimension_tokens[dimension_name][<span class="dv">1</span>],</span>
<span id="cb9-712"><a href="#cb9-712" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"time_ms"</span>: <span class="bu">int</span>(timing.dimension_times[dimension_name] <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb9-713"><a href="#cb9-713" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb9-714"><a href="#cb9-714" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb9-715"><a href="#cb9-715" aria-hidden="true" tabindex="-1"></a>                dimension_data.update({</span>
<span id="cb9-716"><a href="#cb9-716" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"input_tokens"</span>: <span class="va">None</span>,</span>
<span id="cb9-717"><a href="#cb9-717" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"output_tokens"</span>: <span class="va">None</span>,</span>
<span id="cb9-718"><a href="#cb9-718" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"time_ms"</span>: <span class="va">None</span></span>
<span id="cb9-719"><a href="#cb9-719" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb9-720"><a href="#cb9-720" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-721"><a href="#cb9-721" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> dimension_data</span>
<span id="cb9-722"><a href="#cb9-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-723"><a href="#cb9-723" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> create_result_entry(qa_pair: QAPair, scores: DetailedJudgmentScores, timing: QAPairTiming, is_parallel: <span class="bu">bool</span>):</span>
<span id="cb9-724"><a href="#cb9-724" aria-hidden="true" tabindex="-1"></a>            dimensions <span class="op">=</span> [<span class="st">'Helpfulness'</span>, <span class="st">'Relevance'</span>, <span class="st">'Accuracy'</span>, <span class="st">'Depth'</span>, <span class="st">'Creativity'</span>, <span class="st">'Level_of_Detail'</span>]</span>
<span id="cb9-725"><a href="#cb9-725" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-726"><a href="#cb9-726" aria-hidden="true" tabindex="-1"></a>            entry <span class="op">=</span> {</span>
<span id="cb9-727"><a href="#cb9-727" aria-hidden="true" tabindex="-1"></a>                <span class="st">"judge_type"</span>: <span class="st">"parallel"</span> <span class="cf">if</span> is_parallel <span class="cf">else</span> <span class="st">"combined"</span>,</span>
<span id="cb9-728"><a href="#cb9-728" aria-hidden="true" tabindex="-1"></a>                <span class="st">"question"</span>: qa_pair.question,</span>
<span id="cb9-729"><a href="#cb9-729" aria-hidden="true" tabindex="-1"></a>                <span class="st">"answer"</span>: qa_pair.answer,</span>
<span id="cb9-730"><a href="#cb9-730" aria-hidden="true" tabindex="-1"></a>                <span class="st">"model"</span>: qa_pair.model_name</span>
<span id="cb9-731"><a href="#cb9-731" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb9-732"><a href="#cb9-732" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-733"><a href="#cb9-733" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> dim <span class="kw">in</span> dimensions:</span>
<span id="cb9-734"><a href="#cb9-734" aria-hidden="true" tabindex="-1"></a>                entry[dim.lower()] <span class="op">=</span> format_dimension_data(dim, scores, timing, is_parallel)</span>
<span id="cb9-735"><a href="#cb9-735" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-736"><a href="#cb9-736" aria-hidden="true" tabindex="-1"></a>            entry.update({</span>
<span id="cb9-737"><a href="#cb9-737" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sum_input_tokens"</span>: timing.tokens.input_tokens,</span>
<span id="cb9-738"><a href="#cb9-738" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sum_output_tokens"</span>: timing.tokens.output_tokens,</span>
<span id="cb9-739"><a href="#cb9-739" aria-hidden="true" tabindex="-1"></a>                <span class="st">"overall_time_ms"</span>: <span class="bu">int</span>(timing.total_time <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb9-740"><a href="#cb9-740" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb9-741"><a href="#cb9-741" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-742"><a href="#cb9-742" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> entry</span>
<span id="cb9-743"><a href="#cb9-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-744"><a href="#cb9-744" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> Path(<span class="va">self</span>.config.RESULTS_JSONL).<span class="bu">open</span>(<span class="st">'a'</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> f:</span>
<span id="cb9-745"><a href="#cb9-745" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write combined approach results</span></span>
<span id="cb9-746"><a href="#cb9-746" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, (qa_pair, scores, timing) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(qa_pairs, combined_scores, run.combined_pair_times)):</span>
<span id="cb9-747"><a href="#cb9-747" aria-hidden="true" tabindex="-1"></a>                entry <span class="op">=</span> create_result_entry(qa_pair, scores, timing, is_parallel<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-748"><a href="#cb9-748" aria-hidden="true" tabindex="-1"></a>                f.write(json.dumps(entry, ensure_ascii<span class="op">=</span><span class="va">False</span>) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb9-749"><a href="#cb9-749" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-750"><a href="#cb9-750" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Write parallel approach results</span></span>
<span id="cb9-751"><a href="#cb9-751" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, (qa_pair, scores, timing) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(qa_pairs, parallel_scores, run.parallel_pair_times)):</span>
<span id="cb9-752"><a href="#cb9-752" aria-hidden="true" tabindex="-1"></a>                entry <span class="op">=</span> create_result_entry(qa_pair, scores, timing, is_parallel<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-753"><a href="#cb9-753" aria-hidden="true" tabindex="-1"></a>                f.write(json.dumps(entry, ensure_ascii<span class="op">=</span><span class="va">False</span>) <span class="op">+</span> <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb9-754"><a href="#cb9-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-755"><a href="#cb9-755" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-756"><a href="#cb9-756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-757"><a href="#cb9-757" aria-hidden="true" tabindex="-1"></a>And the <span class="in">`Models`</span> module (<span class="in">`models.py`</span>) defines the data structures.</span>
<span id="cb9-758"><a href="#cb9-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-761"><a href="#cb9-761" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-762"><a href="#cb9-762" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-763"><a href="#cb9-763" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-764"><a href="#cb9-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold-show: false</span></span>
<span id="cb9-765"><a href="#cb9-765" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Click to view the Models code"</span></span>
<span id="cb9-766"><a href="#cb9-766" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb9-767"><a href="#cb9-767" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict, List, Tuple, Optional</span>
<span id="cb9-768"><a href="#cb9-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-769"><a href="#cb9-769" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-770"><a href="#cb9-770" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QAPair:</span>
<span id="cb9-771"><a href="#cb9-771" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span></span>
<span id="cb9-772"><a href="#cb9-772" aria-hidden="true" tabindex="-1"></a>    answer: <span class="bu">str</span></span>
<span id="cb9-773"><a href="#cb9-773" aria-hidden="true" tabindex="-1"></a>    model_name: <span class="bu">str</span></span>
<span id="cb9-774"><a href="#cb9-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-775"><a href="#cb9-775" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-776"><a href="#cb9-776" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DimensionAnalysis:</span>
<span id="cb9-777"><a href="#cb9-777" aria-hidden="true" tabindex="-1"></a>    thinking: <span class="bu">str</span></span>
<span id="cb9-778"><a href="#cb9-778" aria-hidden="true" tabindex="-1"></a>    score: <span class="bu">int</span></span>
<span id="cb9-779"><a href="#cb9-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-780"><a href="#cb9-780" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-781"><a href="#cb9-781" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DetailedJudgmentScores:</span>
<span id="cb9-782"><a href="#cb9-782" aria-hidden="true" tabindex="-1"></a>    helpfulness: DimensionAnalysis</span>
<span id="cb9-783"><a href="#cb9-783" aria-hidden="true" tabindex="-1"></a>    relevance: DimensionAnalysis</span>
<span id="cb9-784"><a href="#cb9-784" aria-hidden="true" tabindex="-1"></a>    accuracy: DimensionAnalysis</span>
<span id="cb9-785"><a href="#cb9-785" aria-hidden="true" tabindex="-1"></a>    depth: DimensionAnalysis</span>
<span id="cb9-786"><a href="#cb9-786" aria-hidden="true" tabindex="-1"></a>    creativity: DimensionAnalysis</span>
<span id="cb9-787"><a href="#cb9-787" aria-hidden="true" tabindex="-1"></a>    level_of_detail: DimensionAnalysis</span>
<span id="cb9-788"><a href="#cb9-788" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-789"><a href="#cb9-789" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb9-790"><a href="#cb9-790" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> []</span>
<span id="cb9-791"><a href="#cb9-791" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> dimension <span class="kw">in</span> [<span class="st">'helpfulness'</span>, <span class="st">'relevance'</span>, <span class="st">'accuracy'</span>, <span class="st">'depth'</span>, <span class="st">'creativity'</span>, <span class="st">'level_of_detail'</span>]:</span>
<span id="cb9-792"><a href="#cb9-792" aria-hidden="true" tabindex="-1"></a>            analysis <span class="op">=</span> <span class="bu">getattr</span>(<span class="va">self</span>, dimension)</span>
<span id="cb9-793"><a href="#cb9-793" aria-hidden="true" tabindex="-1"></a>            result.extend([</span>
<span id="cb9-794"><a href="#cb9-794" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>dimension<span class="sc">.</span>title()<span class="sc">}</span><span class="ss">:"</span>,</span>
<span id="cb9-795"><a href="#cb9-795" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Thinking: </span><span class="sc">{</span>analysis<span class="sc">.</span>thinking<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb9-796"><a href="#cb9-796" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Score: </span><span class="sc">{</span>analysis<span class="sc">.</span>score<span class="sc">}</span><span class="ss">/10"</span>,</span>
<span id="cb9-797"><a href="#cb9-797" aria-hidden="true" tabindex="-1"></a>                <span class="st">""</span></span>
<span id="cb9-798"><a href="#cb9-798" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb9-799"><a href="#cb9-799" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(result)</span>
<span id="cb9-800"><a href="#cb9-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-801"><a href="#cb9-801" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-802"><a href="#cb9-802" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QAPairTokens:</span>
<span id="cb9-803"><a href="#cb9-803" aria-hidden="true" tabindex="-1"></a>    input_tokens: <span class="bu">int</span></span>
<span id="cb9-804"><a href="#cb9-804" aria-hidden="true" tabindex="-1"></a>    output_tokens: <span class="bu">int</span></span>
<span id="cb9-805"><a href="#cb9-805" aria-hidden="true" tabindex="-1"></a>    total_tokens: <span class="bu">int</span></span>
<span id="cb9-806"><a href="#cb9-806" aria-hidden="true" tabindex="-1"></a>    dimension_tokens: Optional[Dict[<span class="bu">str</span>, Tuple[<span class="bu">int</span>, <span class="bu">int</span>]]] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-807"><a href="#cb9-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-808"><a href="#cb9-808" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-809"><a href="#cb9-809" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QAPairTiming:</span>
<span id="cb9-810"><a href="#cb9-810" aria-hidden="true" tabindex="-1"></a>    qa_index: <span class="bu">int</span></span>
<span id="cb9-811"><a href="#cb9-811" aria-hidden="true" tabindex="-1"></a>    question: <span class="bu">str</span></span>
<span id="cb9-812"><a href="#cb9-812" aria-hidden="true" tabindex="-1"></a>    total_time: <span class="bu">float</span></span>
<span id="cb9-813"><a href="#cb9-813" aria-hidden="true" tabindex="-1"></a>    tokens: QAPairTokens</span>
<span id="cb9-814"><a href="#cb9-814" aria-hidden="true" tabindex="-1"></a>    dimension_times: Optional[Dict[<span class="bu">str</span>, <span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-815"><a href="#cb9-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-816"><a href="#cb9-816" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb9-817"><a href="#cb9-817" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ExperimentRun:</span>
<span id="cb9-818"><a href="#cb9-818" aria-hidden="true" tabindex="-1"></a>    combined_time: <span class="bu">float</span></span>
<span id="cb9-819"><a href="#cb9-819" aria-hidden="true" tabindex="-1"></a>    parallel_time: <span class="bu">float</span></span>
<span id="cb9-820"><a href="#cb9-820" aria-hidden="true" tabindex="-1"></a>    combined_pair_times: List[QAPairTiming]</span>
<span id="cb9-821"><a href="#cb9-821" aria-hidden="true" tabindex="-1"></a>    parallel_pair_times: List[QAPairTiming]</span>
<span id="cb9-822"><a href="#cb9-822" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-823"><a href="#cb9-823" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb9-824"><a href="#cb9-824" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> time_difference(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb9-825"><a href="#cb9-825" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""B - A: Positive means parallel was slower"""</span></span>
<span id="cb9-826"><a href="#cb9-826" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.parallel_time <span class="op">-</span> <span class="va">self</span>.combined_time</span>
<span id="cb9-827"><a href="#cb9-827" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-828"><a href="#cb9-828" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb9-829"><a href="#cb9-829" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> percent_difference(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb9-830"><a href="#cb9-830" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""((B - A) / A) * 100: Positive means parallel was slower"""</span></span>
<span id="cb9-831"><a href="#cb9-831" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.combined_time <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-832"><a href="#cb9-832" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">float</span>(<span class="st">'inf'</span>) <span class="cf">if</span> <span class="va">self</span>.parallel_time <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb9-833"><a href="#cb9-833" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">self</span>.time_difference <span class="op">/</span> <span class="va">self</span>.combined_time) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb9-834"><a href="#cb9-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-835"><a href="#cb9-835" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb9-836"><a href="#cb9-836" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> combined_tokens(<span class="va">self</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">int</span>, <span class="bu">int</span>, <span class="bu">int</span>]:</span>
<span id="cb9-837"><a href="#cb9-837" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Returns (input_tokens, output_tokens, total_tokens) for combined approach"""</span></span>
<span id="cb9-838"><a href="#cb9-838" aria-hidden="true" tabindex="-1"></a>        input_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.input_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.combined_pair_times)</span>
<span id="cb9-839"><a href="#cb9-839" aria-hidden="true" tabindex="-1"></a>        output_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.output_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.combined_pair_times)</span>
<span id="cb9-840"><a href="#cb9-840" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> input_tokens, output_tokens, input_tokens <span class="op">+</span> output_tokens</span>
<span id="cb9-841"><a href="#cb9-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-842"><a href="#cb9-842" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb9-843"><a href="#cb9-843" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> parallel_tokens(<span class="va">self</span>) <span class="op">-&gt;</span> Tuple[<span class="bu">int</span>, <span class="bu">int</span>, <span class="bu">int</span>]:</span>
<span id="cb9-844"><a href="#cb9-844" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Returns (input_tokens, output_tokens, total_tokens) for parallel approach"""</span></span>
<span id="cb9-845"><a href="#cb9-845" aria-hidden="true" tabindex="-1"></a>        input_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.input_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.parallel_pair_times)</span>
<span id="cb9-846"><a href="#cb9-846" aria-hidden="true" tabindex="-1"></a>        output_tokens <span class="op">=</span> <span class="bu">sum</span>(pt.tokens.output_tokens <span class="cf">for</span> pt <span class="kw">in</span> <span class="va">self</span>.parallel_pair_times)</span>
<span id="cb9-847"><a href="#cb9-847" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> input_tokens, output_tokens, input_tokens <span class="op">+</span> output_tokens </span>
<span id="cb9-848"><a href="#cb9-848" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-849"><a href="#cb9-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-850"><a href="#cb9-850" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis</span></span>
<span id="cb9-851"><a href="#cb9-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-852"><a href="#cb9-852" aria-hidden="true" tabindex="-1"></a><span class="fu">### Latency</span></span>
<span id="cb9-853"><a href="#cb9-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-854"><a href="#cb9-854" aria-hidden="true" tabindex="-1"></a>After running the experiment, we can analyze the latency distributions to determine if the multi-threaded approach was faster:</span>
<span id="cb9-855"><a href="#cb9-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-858"><a href="#cb9-858" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-859"><a href="#cb9-859" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb9-860"><a href="#cb9-860" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb9-861"><a href="#cb9-861" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold-show: false</span></span>
<span id="cb9-862"><a href="#cb9-862" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Click to view the Results Analysis code"</span></span>
<span id="cb9-863"><a href="#cb9-863" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb9-864"><a href="#cb9-864" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-865"><a href="#cb9-865" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb9-866"><a href="#cb9-866" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb9-867"><a href="#cb9-867" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb9-868"><a href="#cb9-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-869"><a href="#cb9-869" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> []</span>
<span id="cb9-870"><a href="#cb9-870" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'experiment_results.jsonl'</span>, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb9-871"><a href="#cb9-871" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">file</span>:</span>
<span id="cb9-872"><a href="#cb9-872" aria-hidden="true" tabindex="-1"></a>        data.append(json.loads(line))</span>
<span id="cb9-873"><a href="#cb9-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-874"><a href="#cb9-874" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate data by judge type and convert to seconds</span></span>
<span id="cb9-875"><a href="#cb9-875" aria-hidden="true" tabindex="-1"></a>parallel_times <span class="op">=</span> [entry[<span class="st">'overall_time_ms'</span>]<span class="op">/</span><span class="dv">1000</span> <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'parallel'</span>]</span>
<span id="cb9-876"><a href="#cb9-876" aria-hidden="true" tabindex="-1"></a>combined_times <span class="op">=</span> [entry[<span class="st">'overall_time_ms'</span>]<span class="op">/</span><span class="dv">1000</span> <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'combined'</span>]</span>
<span id="cb9-877"><a href="#cb9-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-878"><a href="#cb9-878" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate medians</span></span>
<span id="cb9-879"><a href="#cb9-879" aria-hidden="true" tabindex="-1"></a>median_parallel <span class="op">=</span> <span class="bu">sorted</span>(parallel_times)[<span class="bu">len</span>(parallel_times)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-880"><a href="#cb9-880" aria-hidden="true" tabindex="-1"></a>median_combined <span class="op">=</span> <span class="bu">sorted</span>(combined_times)[<span class="bu">len</span>(combined_times)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-881"><a href="#cb9-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-882"><a href="#cb9-882" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate pairwise percentage differences</span></span>
<span id="cb9-883"><a href="#cb9-883" aria-hidden="true" tabindex="-1"></a>pct_diffs <span class="op">=</span> []</span>
<span id="cb9-884"><a href="#cb9-884" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry_parallel <span class="kw">in</span> data:</span>
<span id="cb9-885"><a href="#cb9-885" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> entry_parallel[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'parallel'</span>:</span>
<span id="cb9-886"><a href="#cb9-886" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry_combined <span class="kw">in</span> data:</span>
<span id="cb9-887"><a href="#cb9-887" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (entry_combined[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'combined'</span> <span class="kw">and</span> </span>
<span id="cb9-888"><a href="#cb9-888" aria-hidden="true" tabindex="-1"></a>                entry_parallel[<span class="st">'question'</span>] <span class="op">==</span> entry_combined[<span class="st">'question'</span>] <span class="kw">and</span> </span>
<span id="cb9-889"><a href="#cb9-889" aria-hidden="true" tabindex="-1"></a>                entry_parallel.get(<span class="st">'model'</span>) <span class="op">==</span> entry_combined.get(<span class="st">'model'</span>)):</span>
<span id="cb9-890"><a href="#cb9-890" aria-hidden="true" tabindex="-1"></a>                pct_diff <span class="op">=</span> ((entry_parallel[<span class="st">'overall_time_ms'</span>] <span class="op">-</span> entry_combined[<span class="st">'overall_time_ms'</span>]) <span class="op">/</span> </span>
<span id="cb9-891"><a href="#cb9-891" aria-hidden="true" tabindex="-1"></a>                          entry_combined[<span class="st">'overall_time_ms'</span>] <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb9-892"><a href="#cb9-892" aria-hidden="true" tabindex="-1"></a>                pct_diffs.append(pct_diff)</span>
<span id="cb9-893"><a href="#cb9-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-894"><a href="#cb9-894" aria-hidden="true" tabindex="-1"></a>median_pct_diff <span class="op">=</span> <span class="bu">sorted</span>(pct_diffs)[<span class="bu">len</span>(pct_diffs)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-895"><a href="#cb9-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-896"><a href="#cb9-896" aria-hidden="true" tabindex="-1"></a><span class="co"># Create kernel density estimation</span></span>
<span id="cb9-897"><a href="#cb9-897" aria-hidden="true" tabindex="-1"></a>kernel_parallel <span class="op">=</span> stats.gaussian_kde(parallel_times)</span>
<span id="cb9-898"><a href="#cb9-898" aria-hidden="true" tabindex="-1"></a>kernel_combined <span class="op">=</span> stats.gaussian_kde(combined_times)</span>
<span id="cb9-899"><a href="#cb9-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-900"><a href="#cb9-900" aria-hidden="true" tabindex="-1"></a><span class="co"># Create x range for smooth plotting</span></span>
<span id="cb9-901"><a href="#cb9-901" aria-hidden="true" tabindex="-1"></a>x_range <span class="op">=</span> np.linspace(<span class="bu">min</span>(<span class="bu">min</span>(parallel_times), <span class="bu">min</span>(combined_times)),</span>
<span id="cb9-902"><a href="#cb9-902" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">max</span>(<span class="bu">max</span>(parallel_times), <span class="bu">max</span>(combined_times)),</span>
<span id="cb9-903"><a href="#cb9-903" aria-hidden="true" tabindex="-1"></a>                      <span class="dv">200</span>)</span>
<span id="cb9-904"><a href="#cb9-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-905"><a href="#cb9-905" aria-hidden="true" tabindex="-1"></a><span class="co"># Create figure</span></span>
<span id="cb9-906"><a href="#cb9-906" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb9-907"><a href="#cb9-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-908"><a href="#cb9-908" aria-hidden="true" tabindex="-1"></a><span class="co"># Add density plots</span></span>
<span id="cb9-909"><a href="#cb9-909" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>x_range, </span>
<span id="cb9-910"><a href="#cb9-910" aria-hidden="true" tabindex="-1"></a>                        y<span class="op">=</span>kernel_parallel(x_range),</span>
<span id="cb9-911"><a href="#cb9-911" aria-hidden="true" tabindex="-1"></a>                        name<span class="op">=</span><span class="st">'Multiple Threads'</span>,</span>
<span id="cb9-912"><a href="#cb9-912" aria-hidden="true" tabindex="-1"></a>                        fill<span class="op">=</span><span class="st">'tozeroy'</span>,</span>
<span id="cb9-913"><a href="#cb9-913" aria-hidden="true" tabindex="-1"></a>                        line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>),</span>
<span id="cb9-914"><a href="#cb9-914" aria-hidden="true" tabindex="-1"></a>                        opacity<span class="op">=</span><span class="fl">0.6</span>))</span>
<span id="cb9-915"><a href="#cb9-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-916"><a href="#cb9-916" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>x_range, </span>
<span id="cb9-917"><a href="#cb9-917" aria-hidden="true" tabindex="-1"></a>                        y<span class="op">=</span>kernel_combined(x_range),</span>
<span id="cb9-918"><a href="#cb9-918" aria-hidden="true" tabindex="-1"></a>                        name<span class="op">=</span><span class="st">'Single Thread'</span>,</span>
<span id="cb9-919"><a href="#cb9-919" aria-hidden="true" tabindex="-1"></a>                        fill<span class="op">=</span><span class="st">'tozeroy'</span>,</span>
<span id="cb9-920"><a href="#cb9-920" aria-hidden="true" tabindex="-1"></a>                        line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>),</span>
<span id="cb9-921"><a href="#cb9-921" aria-hidden="true" tabindex="-1"></a>                        opacity<span class="op">=</span><span class="fl">0.6</span>))</span>
<span id="cb9-922"><a href="#cb9-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-923"><a href="#cb9-923" aria-hidden="true" tabindex="-1"></a><span class="co"># Add statistics box</span></span>
<span id="cb9-924"><a href="#cb9-924" aria-hidden="true" tabindex="-1"></a>stats_text <span class="op">=</span> (</span>
<span id="cb9-925"><a href="#cb9-925" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Median response times:&lt;br&gt;"</span></span>
<span id="cb9-926"><a href="#cb9-926" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Multiple Threads: </span><span class="sc">{</span>median_parallel<span class="sc">:.0f}</span><span class="ss">s&lt;br&gt;"</span></span>
<span id="cb9-927"><a href="#cb9-927" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Single Thread: </span><span class="sc">{</span>median_combined<span class="sc">:.0f}</span><span class="ss">s&lt;br&gt;&lt;br&gt;"</span></span>
<span id="cb9-928"><a href="#cb9-928" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Median % difference: </span><span class="sc">{</span>median_pct_diff<span class="sc">:.0f}</span><span class="ss">%"</span></span>
<span id="cb9-929"><a href="#cb9-929" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-930"><a href="#cb9-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-931"><a href="#cb9-931" aria-hidden="true" tabindex="-1"></a>fig.add_annotation(</span>
<span id="cb9-932"><a href="#cb9-932" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="fl">0.98</span>,  <span class="co"># Changed from 0.02 to 0.98 to move to right side</span></span>
<span id="cb9-933"><a href="#cb9-933" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="fl">0.98</span>,</span>
<span id="cb9-934"><a href="#cb9-934" aria-hidden="true" tabindex="-1"></a>    xref<span class="op">=</span><span class="st">"paper"</span>,</span>
<span id="cb9-935"><a href="#cb9-935" aria-hidden="true" tabindex="-1"></a>    yref<span class="op">=</span><span class="st">"paper"</span>,</span>
<span id="cb9-936"><a href="#cb9-936" aria-hidden="true" tabindex="-1"></a>    text<span class="op">=</span>stats_text,</span>
<span id="cb9-937"><a href="#cb9-937" aria-hidden="true" tabindex="-1"></a>    showarrow<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb9-938"><a href="#cb9-938" aria-hidden="true" tabindex="-1"></a>    font<span class="op">=</span><span class="bu">dict</span>(size<span class="op">=</span><span class="dv">12</span>),</span>
<span id="cb9-939"><a href="#cb9-939" aria-hidden="true" tabindex="-1"></a>    align<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb9-940"><a href="#cb9-940" aria-hidden="true" tabindex="-1"></a>    bgcolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb9-941"><a href="#cb9-941" aria-hidden="true" tabindex="-1"></a>    bordercolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb9-942"><a href="#cb9-942" aria-hidden="true" tabindex="-1"></a>    borderwidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb9-943"><a href="#cb9-943" aria-hidden="true" tabindex="-1"></a>    xanchor<span class="op">=</span><span class="st">"right"</span>,  <span class="co"># Changed from 'left' to 'right'</span></span>
<span id="cb9-944"><a href="#cb9-944" aria-hidden="true" tabindex="-1"></a>    yanchor<span class="op">=</span><span class="st">"top"</span></span>
<span id="cb9-945"><a href="#cb9-945" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-946"><a href="#cb9-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-947"><a href="#cb9-947" aria-hidden="true" tabindex="-1"></a><span class="co"># Update layout</span></span>
<span id="cb9-948"><a href="#cb9-948" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb9-949"><a href="#cb9-949" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Density Plot of Overall Time by Judge Type'</span>,</span>
<span id="cb9-950"><a href="#cb9-950" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Time (seconds)'</span>,</span>
<span id="cb9-951"><a href="#cb9-951" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Density'</span>,</span>
<span id="cb9-952"><a href="#cb9-952" aria-hidden="true" tabindex="-1"></a>    showlegend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-953"><a href="#cb9-953" aria-hidden="true" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">600</span>,</span>
<span id="cb9-954"><a href="#cb9-954" aria-hidden="true" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span></span>
<span id="cb9-955"><a href="#cb9-955" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-956"><a href="#cb9-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-957"><a href="#cb9-957" aria-hidden="true" tabindex="-1"></a>fig.show()</span>
<span id="cb9-958"><a href="#cb9-958" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-959"><a href="#cb9-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-960"><a href="#cb9-960" aria-hidden="true" tabindex="-1"></a>The density plot above shows the distribution of response times for both approaches. The multi-threaded approach was indeed faster -- it reduced latency by ~38% on average (median difference) compared to the single-threaded approach.</span>
<span id="cb9-961"><a href="#cb9-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-962"><a href="#cb9-962" aria-hidden="true" tabindex="-1"></a><span class="fu">### Token Usage</span></span>
<span id="cb9-963"><a href="#cb9-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-966"><a href="#cb9-966" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb9-967"><a href="#cb9-967" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate token data by judge type</span></span>
<span id="cb9-968"><a href="#cb9-968" aria-hidden="true" tabindex="-1"></a>parallel_input_tokens <span class="op">=</span> [entry[<span class="st">'sum_input_tokens'</span>] <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'parallel'</span>]</span>
<span id="cb9-969"><a href="#cb9-969" aria-hidden="true" tabindex="-1"></a>parallel_output_tokens <span class="op">=</span> [entry[<span class="st">'sum_output_tokens'</span>] <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'parallel'</span>]</span>
<span id="cb9-970"><a href="#cb9-970" aria-hidden="true" tabindex="-1"></a>combined_input_tokens <span class="op">=</span> [entry[<span class="st">'sum_input_tokens'</span>] <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'combined'</span>]</span>
<span id="cb9-971"><a href="#cb9-971" aria-hidden="true" tabindex="-1"></a>combined_output_tokens <span class="op">=</span> [entry[<span class="st">'sum_output_tokens'</span>] <span class="cf">for</span> entry <span class="kw">in</span> data <span class="cf">if</span> entry[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'combined'</span>]</span>
<span id="cb9-972"><a href="#cb9-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-973"><a href="#cb9-973" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate medians</span></span>
<span id="cb9-974"><a href="#cb9-974" aria-hidden="true" tabindex="-1"></a>median_parallel_input <span class="op">=</span> <span class="bu">sorted</span>(parallel_input_tokens)[<span class="bu">len</span>(parallel_input_tokens)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-975"><a href="#cb9-975" aria-hidden="true" tabindex="-1"></a>median_parallel_output <span class="op">=</span> <span class="bu">sorted</span>(parallel_output_tokens)[<span class="bu">len</span>(parallel_output_tokens)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-976"><a href="#cb9-976" aria-hidden="true" tabindex="-1"></a>median_combined_input <span class="op">=</span> <span class="bu">sorted</span>(combined_input_tokens)[<span class="bu">len</span>(combined_input_tokens)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-977"><a href="#cb9-977" aria-hidden="true" tabindex="-1"></a>median_combined_output <span class="op">=</span> <span class="bu">sorted</span>(combined_output_tokens)[<span class="bu">len</span>(combined_output_tokens)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-978"><a href="#cb9-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-979"><a href="#cb9-979" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate pairwise percentage differences</span></span>
<span id="cb9-980"><a href="#cb9-980" aria-hidden="true" tabindex="-1"></a>input_pct_diffs <span class="op">=</span> []</span>
<span id="cb9-981"><a href="#cb9-981" aria-hidden="true" tabindex="-1"></a>output_pct_diffs <span class="op">=</span> []</span>
<span id="cb9-982"><a href="#cb9-982" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> entry_parallel <span class="kw">in</span> data:</span>
<span id="cb9-983"><a href="#cb9-983" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> entry_parallel[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'parallel'</span>:</span>
<span id="cb9-984"><a href="#cb9-984" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> entry_combined <span class="kw">in</span> data:</span>
<span id="cb9-985"><a href="#cb9-985" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (entry_combined[<span class="st">'judge_type'</span>] <span class="op">==</span> <span class="st">'combined'</span> <span class="kw">and</span> </span>
<span id="cb9-986"><a href="#cb9-986" aria-hidden="true" tabindex="-1"></a>                entry_parallel[<span class="st">'question'</span>] <span class="op">==</span> entry_combined[<span class="st">'question'</span>] <span class="kw">and</span> </span>
<span id="cb9-987"><a href="#cb9-987" aria-hidden="true" tabindex="-1"></a>                entry_parallel.get(<span class="st">'model'</span>) <span class="op">==</span> entry_combined.get(<span class="st">'model'</span>)):</span>
<span id="cb9-988"><a href="#cb9-988" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Input tokens difference</span></span>
<span id="cb9-989"><a href="#cb9-989" aria-hidden="true" tabindex="-1"></a>                input_pct_diff <span class="op">=</span> ((entry_parallel[<span class="st">'sum_input_tokens'</span>] <span class="op">-</span> entry_combined[<span class="st">'sum_input_tokens'</span>]) <span class="op">/</span> </span>
<span id="cb9-990"><a href="#cb9-990" aria-hidden="true" tabindex="-1"></a>                                entry_combined[<span class="st">'sum_input_tokens'</span>] <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb9-991"><a href="#cb9-991" aria-hidden="true" tabindex="-1"></a>                input_pct_diffs.append(input_pct_diff)</span>
<span id="cb9-992"><a href="#cb9-992" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-993"><a href="#cb9-993" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Output tokens difference</span></span>
<span id="cb9-994"><a href="#cb9-994" aria-hidden="true" tabindex="-1"></a>                output_pct_diff <span class="op">=</span> ((entry_parallel[<span class="st">'sum_output_tokens'</span>] <span class="op">-</span> entry_combined[<span class="st">'sum_output_tokens'</span>]) <span class="op">/</span> </span>
<span id="cb9-995"><a href="#cb9-995" aria-hidden="true" tabindex="-1"></a>                                 entry_combined[<span class="st">'sum_output_tokens'</span>] <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb9-996"><a href="#cb9-996" aria-hidden="true" tabindex="-1"></a>                output_pct_diffs.append(output_pct_diff)</span>
<span id="cb9-997"><a href="#cb9-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-998"><a href="#cb9-998" aria-hidden="true" tabindex="-1"></a>median_input_pct_diff <span class="op">=</span> <span class="bu">sorted</span>(input_pct_diffs)[<span class="bu">len</span>(input_pct_diffs)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-999"><a href="#cb9-999" aria-hidden="true" tabindex="-1"></a>median_output_pct_diff <span class="op">=</span> <span class="bu">sorted</span>(output_pct_diffs)[<span class="bu">len</span>(output_pct_diffs)<span class="op">//</span><span class="dv">2</span>]</span>
<span id="cb9-1000"><a href="#cb9-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1001"><a href="#cb9-1001" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb9-1002"><a href="#cb9-1002" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Token Usage Summary:"</span>)</span>
<span id="cb9-1003"><a href="#cb9-1003" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Multiple Threads:"</span>)</span>
<span id="cb9-1004"><a href="#cb9-1004" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Median Input Tokens:  </span><span class="sc">{</span>median_parallel_input<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb9-1005"><a href="#cb9-1005" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Median Output Tokens: </span><span class="sc">{</span>median_parallel_output<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb9-1006"><a href="#cb9-1006" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Single Thread:"</span>)</span>
<span id="cb9-1007"><a href="#cb9-1007" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Median Input Tokens:  </span><span class="sc">{</span>median_combined_input<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb9-1008"><a href="#cb9-1008" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Median Output Tokens: </span><span class="sc">{</span>median_combined_output<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb9-1009"><a href="#cb9-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1010"><a href="#cb9-1010" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Median Pairwise Differences:"</span>)</span>
<span id="cb9-1011"><a href="#cb9-1011" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Input Tokens:  </span><span class="sc">{</span>median_input_pct_diff<span class="sc">:+.1f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1012"><a href="#cb9-1012" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Output Tokens: </span><span class="sc">{</span>median_output_pct_diff<span class="sc">:+.1f}</span><span class="ss">%"</span>)</span>
<span id="cb9-1013"><a href="#cb9-1013" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-1014"><a href="#cb9-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1015"><a href="#cb9-1015" aria-hidden="true" tabindex="-1"></a>As expected, token usage increased for the multi-threaded approach. This is due to many of the same input tokens being used for each thread, but also due to the additional output tokens generated by each thread. More output tokens may reflect the additional reasoning and analysis performed by the LLM for each dimension, which may result in higher quality evaluations -- but this was not evaluated here.</span>
<span id="cb9-1016"><a href="#cb9-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1017"><a href="#cb9-1017" aria-hidden="true" tabindex="-1"></a><span class="fu">## Limitations</span></span>
<span id="cb9-1018"><a href="#cb9-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1019"><a href="#cb9-1019" aria-hidden="true" tabindex="-1"></a>This analysis has some limitations that are worth noting. Namely, I didn't evaluate the quality / accuracy of the LLM Judge evaluations. I focused only on the latency and token usage of the LLM Judges. I expect that the quality would be equal (or possibly even better) when using the multi-threaded approach, but I didn't evaluate that here.</span>
<span id="cb9-1020"><a href="#cb9-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1021"><a href="#cb9-1021" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb9-1022"><a href="#cb9-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-1023"><a href="#cb9-1023" aria-hidden="true" tabindex="-1"></a>This experiment demonstrated the significant performance benefits of a multi-threaded approach when implementing an LLM judge to evaluate text quality across multiple dimensions. By breaking down the evaluation task into six orthogonal dimensions and processing them in parallel, latency was reduced by ~38% compared to evaluating all dimensions in a single LLM call. At the same time, token usage increased, which may result in higher quality evaluations -- but this was not here.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block"><a href="https://creativecommons.org/licenses/by/4.0/"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i></a> 2014–2025 Tyler Burleigh</span></p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p><span class="faux-block">Made with <i class="fa-brands fa-r-project" aria-label="r-project"></i>, <a href="https://quarto.org/">Quarto</a>, and the <a href="https://github.com/andrewheiss/ath-quarto">ath-quarto</a> theme</span></p>
</div>
  </div>
</footer>




</body></html>